<!DOCTYPE html>
<html><head>
    <title>Amazon Weight Model Deep Dive</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif; font-size: 14px; line-height: 1.4; margin: 20px; background-color: #f8f9fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .header h1 { margin: 0 0 10px 0; }
        .export-btn { position: absolute; top: 20px; right: 20px; background-color: #ffffff; color: #764ba2; border: 1px solid #764ba2; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .export-btn:hover { background-color: #f1eafa; }
        .trace-container { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; padding: 10px; }
        .call-node { margin: 4px 0; border-radius: 6px; overflow: hidden; }
        .call-header { padding: 8px 12px; cursor: pointer; border: 1px solid #dee2e6; border-radius: 6px; display: flex; align-items: center; transition: all 0.2s; background: linear-gradient(90deg, #ffffff 0%, #f8f9fa 100%); }
        .call-header:hover { background: linear-gradient(90deg, #e9ecef 0%, #f8f9fa 100%); border-color: #adb5bd; }
        .toggle-icon { margin-right: 8px; font-weight: bold; color: #6c757d; width: 12px; text-align: center; font-family: 'Courier New', monospace; }
        .function-name { font-weight: bold; color: #495057; font-family: 'Courier New', monospace; }
        .method-indicator { color: #6f42c1; font-size: 12px; margin-right: 4px; font-family: 'Courier New', monospace; }
        .file-info { color: #6c757d; font-size: 12px; margin-left: 8px; font-family: 'Courier New', monospace;}
        .thread-info { font-size: 11px; color: #17a2b8; font-weight: bold; margin-left: auto; padding-left: 16px; }
        .call-content { display: none; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 6px 6px; background-color: #ffffff; }
        .call-content.show { display: block; }
        .call-info { padding: 12px; background-color: #fdfdfd; }
        .call-children { padding: 8px 8px 8px 20px; background-color: #ffffff; border-left: 3px solid #e9ecef; margin-left: 12px; }
        .args-section, .return-section, .source-section { margin-top: 12px; }
        .section-title { font-weight: bold; color: #343a40; margin-bottom: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .args-section .section-title { margin-bottom: 4px; }
        .args-list { background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; }
        .return-value { background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; color: #0056b3; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; }
        .source-toggle { background: #6c757d; color: white; border: none; padding: 4px 8px; font-size: 11px; border-radius: 4px; cursor: pointer; }
        .source-container { display: none; margin-top: 8px; border: 1px solid #ced4da; border-radius: 4px; max-height: 500px; overflow: auto; }
        .source-container pre { margin: 0; }
        .comment-section { margin-bottom: 12px; }
        .comment-header { display: flex; align-items: center; margin-bottom: 5px; }
        .comment-header .section-title { margin-right: 8px; }
        .comment-toggle-edit-btn, .comment-save-btn { background-color: #f8f9fa; border: 1px solid #dee2e6; color: #495057; padding: 2px 8px; font-size: 11px; border-radius: 4px; cursor: pointer; }
        .comment-toggle-edit-btn:hover, .comment-save-btn:hover { background-color: #e9ecef; }
        .comment-content .comment-output { padding: 10px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef; min-height: 20px; word-wrap: break-word; }
        .comment-content .comment-output pre { white-space: pre-wrap; }
        .comment-edit-controls { display: none; margin-top: 8px; }
        .comment-edit-controls .comment-input { width: 100%; box-sizing: border-box; min-height: 80px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-family: inherit; font-size: 14px; }
        .comment-edit-controls .comment-save-btn { margin-top: 8px; }
        .comment-save-btn { display: none; }
        .comment-section:not([data-editing="true"]) .comment-output:empty { display: none; }
        .comment-section[data-editing="true"] .comment-edit-controls { display: block; }
        .comment-section[data-editing="true"] .comment-toggle-edit-btn { display: none; }
        .comment-section[data-editing="true"] .comment-save-btn { display: inline-block; }
        .comment-section[data-editing="true"] .comment-output { border-top: 1px dashed #ccc; margin-top: 10px; padding-top: 10px; background-color: #fff; }
        .trace-image {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: block;
            margin: 8px 0;
        }
        
        .trace-image:not([data-expanded="true"]) {
            max-width: 172px;
            max-height: 172px;
            width: auto;
            height: auto;
        }
        
        .trace-image[data-expanded="true"] {
            max-width: 768px;
            max-height: 768px;
            width: auto;
            height: auto;
        }
        
        .trace-image:hover {
            border-color: #999;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .depth-0 > .call-header { border-left: 4px solid #dc3545; } .depth-1 > .call-header { border-left: 4px solid #fd7e14; }
        .depth-2 > .call-header { border-left: 4px solid #ffc107; } .depth-3 > .call-header { border-left: 4px solid #28a745; }
        .depth-4 > .call-header { border-left: 4px solid #007bff; } .depth-5 > .call-header { border-left: 4px solid #6f42c1; }
    </style>
</head>
<body data-request-id="call_1753222128112">
    <div class="header">
        <h1>üîç Explaining The Weight Model</h1>
        <h2>A system diagram + function trace</h2>
        <p>Request ID: call_1753222128112</p>
        <p>Total calls captured: 39</p>
        <button class="export-btn" onclick="exportFullHTML()">Export Trace</button>
    </div>
    <div>
        <h3 style="text-align: center">Model Diagram</h3>

        <img style="display: block; margin: 0 auto; max-width: 720px;" src="images/system_diagram.svg" />
    </div>

    <div class="trace-container">
        
        
            
                
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-0" id="node-0">
        <div class="call-header" onclick="toggleCall(0)">
            <span class="toggle-icon" id="icon-0">‚ñº</span>
            
        <span class="function-name">predict()</span>
    
            
        <span class="file-info">[server.py:40]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-0" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-0" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(0)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(0)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-0"><h1>Architecture Overview</h1>
<p>This page describes the Amazon FC weight model server, by tracing a function call to the server.</p>
<p>The entry point to the server is: <code>machine_learning/inference/amazon_fc_weight_estimation/server.py</code>
<p>The server will be used to serve production inference for Amazon FC, including weights for cardboard boxes (in grams)</p>
<p>This server runs two YOLO models, one being Giordano's Amazon FC object detection model, and the other being a segmentation model for cardboard boxes.</p>
<p>This server will return <em>all</em> detections, from Giordano's model, with a weight estimate added for Cardboard boxes.</p>
<p>This contract is identical to Prateek's server.</p>
<h2>Weight Model Overview</h2>
<p>To <em>estimate</em> the weight of a bounding box, we use the following equation:</p>
<h3>Weight = Surface Area * Grams/M<sup>2</sup></h3>
<p>The idea is to first estimate the surface area based on the box dimensions.</p>
<p>Then, we predict the weight based on the surface area.</p>
<p>This linear estimate is a regression equation.</p>
<p>We found the best values for each scanner based on the weights collected by Jamie and David.</p>
<h2>Estimating Surface Area</h2>
<ul>
<li>Use the existing Cardboard box model (made by Giordano)</li>
<li>Run a second <em>segmentation</em> model to find the base of boxes (<code>BOX_BASE</code>)</li>
<li>Match up the <code>BOX_BASE</code> and <code>CARDBOARD</code> detections based on IOU.</li>
<li>Load the depth map</li>
<li>Using the <code>BOX_BASE</code>, the depth map, and constants from a given facility, estimate the length, width, and height of the box in CM.</li>
<li>Use the following equation to estimate Surface Area:</li>
</ul>
<pre><code>Surface Area = 2 * (L * W + L * H + W * H)
</code></pre>
<p>Finally, we use a linear regression to estimate the weight:</p>
<pre><code>weight = A * weight + B
</code></pre>
<p>Where <code>A</code> and <code>B</code> are specified in <code>machine_learning/inference/amazon_fc_weight_estimation/consts.py</code></p>
<p>Use this code explorer to go more in depth! Take a look at the images and dataframes for more intuition.</p>
<p>Some of the code is omitted. If you feel confused, expand the source code for a specific function call.</p>
<p>I have pre-expanded some parts of the trace for you and added comments. Let me know if you have questions!</p>
<p>Matt</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-0" oninput="previewComment(0)" placeholder="Type your comment here. Markdown is supported." data-comment="# Architecture Overview
This server runs two YOLO models, one being Giordano's Amazon FC object detection model, and the other being a segmentation model for cardboard boxes.

This server will return _all_ detections, from Giordano's model, with a weight estimate added for Cardboard boxes.

This contract is identical to Prateek's server.

## Weight Model Overview

To _estimate_ the weight of a bounding box, we use the following equation:


### Weight = Surface Area * Grams/M&lt;sup&gt;2&lt;/sup&gt;

The idea is to first estimate the surface area based on the box dimensions.

Then, we predict the weight based on the surface area.

This linear estimate is a regression equation.

We found the best values for each scanner based on the weights collected by Jamie and David.

## Estimating Surface Area
- Use the existing Cardboard box model (made by Giordano)
- Run a second _segmentation_ model to find the base of boxes (`BOX_BASE`)
- Match up the `BOX_BASE` and `CARDBOARD` detections based on IOU.
- Load the depth map
- Using the `BOX_BASE`, the depth map, and constants from a given facility, estimate the length, width, and height of the box in CM.
- Use the following equation to estimate Surface Area:

```
Surface Area = 2 * (L * W + L * H + W * H)
```

Finally, we use a linear regression to estimate the weight:

```
weight = A * weight + B
```
Where `A` and `B` are specified in `machine_learning/inference/amazon_fc_weight_estimation/consts.py`

Use this code explorer to go more in depth! Take a look at the images and dataframes for more intuition.

Some of the code is omitted. If you feel confused, expand the source code for a specific function call.

I have pre-expanded some parts of the trace for you and added comments. Let me know if you have questions!

Matt
"></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            No arguments. The request variable has property <em>s3_uri:</em><br><span>'s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg'</span>
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">flask.wrappers.Response(response=[b'[{"box":[0.15648148148148147,0.4296875,0.7870370370370371,0.7510416666666667],"class_name":"CARDBOARD","score":0.9619330167770386,"weight":325.3363279464092},{"box":[0.2574074074074074,0.4828125,0.2935185185185185,0.5067708333333333],"class_name":"OTHER_MATERIAL","score":0.4542120397090912}]\n'], status='200 OK', headers=werkzeug.datastructures.headers.Headers(), mimetype='application/json', content_type='application/json', direct_passthrough=False)</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(0)">Show/Hide</button>
                <div class="source-container" id="source-0" data-source-visible="false" style="display: none;">
                    <pre class="language-python" tabindex="0"><code class="language-python">    <span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/predict"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token decorator annotation punctuation">@trace_calls</span><span class="token punctuation">(</span>request_id_key<span class="token operator">=</span><span class="token string">"s3_uri"</span><span class="token punctuation">,</span> output_dir<span class="token operator">=</span>TRACE_OUTPUT_DIR<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Any<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Handle prediction requests for an image.

        Returns:
            JSON response with prediction results
        """</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>json <span class="token keyword">or</span> <span class="token string">"s3_uri"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>json<span class="token punctuation">:</span>
            elapsed_ms <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"Request failed (missing s3_uri) - Duration: </span><span class="token interpolation"><span class="token punctuation">{</span>elapsed_ms<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span>
            <span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>
                jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Missing 's3_uri' in request JSON body."</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">400</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

        s3_uri <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">"s3_uri"</span><span class="token punctuation">]</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Processing prediction request for: </span><span class="token interpolation"><span class="token punctuation">{</span>s3_uri<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> machine_learning<span class="token punctuation">.</span>image_ops<span class="token punctuation">.</span>read_image<span class="token punctuation">(</span>s3_uri<span class="token punctuation">)</span>

            inference_start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># run these puppies in parallel!</span>
            bbox_future <span class="token operator">=</span> executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>
                run_inference_for_images_in_memory<span class="token punctuation">,</span>
                cardboard_model_executor<span class="token punctuation">,</span>
                <span class="token punctuation">[</span>image<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span>s3_uri<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

            segmentation_future <span class="token operator">=</span> executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>
                run_inference_for_images_in_memory<span class="token punctuation">,</span>
                box_base_model_executor<span class="token punctuation">,</span>
                <span class="token punctuation">[</span>image<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span>s3_uri<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

            bounding_box_inference_results <span class="token operator">=</span> bbox_future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
            box_base_segmentation_inference_results <span class="token operator">=</span> segmentation_future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>

            inference_elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> inference_start

            weight_start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
            weight_df <span class="token operator">=</span> weight_model<span class="token punctuation">.</span>run_weight_inference_for_dataframes<span class="token punctuation">(</span>
                bounding_box_inference_results<span class="token punctuation">,</span>
                box_base_segmentation_inference_results<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            weight_elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> weight_start

            id_to_weight <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>weight_df<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> weight_df<span class="token punctuation">.</span>weight<span class="token punctuation">)</span><span class="token punctuation">)</span>

            results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> _<span class="token punctuation">,</span> row <span class="token keyword">in</span> bounding_box_inference_results<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token string">"box"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>row<span class="token punctuation">.</span>ymin<span class="token punctuation">,</span> row<span class="token punctuation">.</span>xmin<span class="token punctuation">,</span> row<span class="token punctuation">.</span>ymax<span class="token punctuation">,</span> row<span class="token punctuation">.</span>xmax<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"class_name"</span><span class="token punctuation">:</span> row<span class="token punctuation">.</span>class_name<span class="token punctuation">,</span>
                    <span class="token string">"score"</span><span class="token punctuation">:</span> row<span class="token punctuation">.</span>score<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                weight <span class="token operator">=</span> id_to_weight<span class="token punctuation">.</span>get<span class="token punctuation">(</span>row<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> weight<span class="token punctuation">:</span>
                    result<span class="token punctuation">[</span><span class="token string">"weight"</span><span class="token punctuation">]</span> <span class="token operator">=</span> weight

                results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result<span class="token punctuation">)</span>

            total_elapsed_ms <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
            num_detections <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>

            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"Request completed successfully - "</span></span>
                <span class="token string-interpolation"><span class="token string">f"S3 URI: </span><span class="token interpolation"><span class="token punctuation">{</span>s3_uri<span class="token punctuation">}</span></span><span class="token string">, "</span></span>
                <span class="token string-interpolation"><span class="token string">f"Detections: </span><span class="token interpolation"><span class="token punctuation">{</span>num_detections<span class="token punctuation">}</span></span><span class="token string">, "</span></span>
                <span class="token string-interpolation"><span class="token string">f"Total Duration: </span><span class="token interpolation"><span class="token punctuation">{</span>total_elapsed_ms<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">ms, "</span></span>
                <span class="token string-interpolation"><span class="token string">f"Breakdown: inference=</span><span class="token interpolation"><span class="token punctuation">{</span>inference_elapsed <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">ms, "</span></span>
                <span class="token string-interpolation"><span class="token string">f"weight=</span><span class="token interpolation"><span class="token punctuation">{</span>weight_elapsed <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span>
            <span class="token punctuation">)</span>

            <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span>results<span class="token punctuation">)</span>

        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            elapsed_ms <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
            error_trace <span class="token operator">=</span> traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"Request failed with error - "</span></span>
                <span class="token string-interpolation"><span class="token string">f"S3 URI: </span><span class="token interpolation"><span class="token punctuation">{</span>s3_uri<span class="token punctuation">}</span></span><span class="token string">, "</span></span>
                <span class="token string-interpolation"><span class="token string">f"Duration: </span><span class="token interpolation"><span class="token punctuation">{</span>elapsed_ms<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">ms, "</span></span>
                <span class="token string-interpolation"><span class="token string">f"Error: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">{</span>error_trace<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token punctuation">)</span>
            <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"traceback"</span><span class="token punctuation">:</span> error_trace<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-1" id="node-1">
        <div class="call-header" onclick="toggleCall(1)">
            <span class="toggle-icon" id="icon-1">‚ñ∂</span>
            
        <span class="function-name">image = machine_learning.image_ops.read_image(s3_uri)</span>
    
            
        <span class="file-info">[image_ops.py:64]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-1" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-1" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(1)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(1)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-1"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-1" oninput="previewComment(1)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">filepath:</span> <span style="color: rgb(0, 86, 179);">'s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg'</span></div>
            
                <div><span style="color: #505050;">as_gray:</span> <span style="color: rgb(0, 86, 179);">False</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value"><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_1.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_1" data-expanded="false" onclick="toggleImageSize('img_1')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(1)">Show/Hide</button>
                <div class="source-container" id="source-1">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">read_image</span><span class="token punctuation">(</span>filepath<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> as_gray<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> RGBImage<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Read an image from local disk or S3.

    Arguments:
        filepath: Where to read the image from.
        as_gray: If True, reads the image in grayscale mode. Defaults to False.

    Returns:
        A numpy array with the image data
            - The array is shaped (height, width, channels) where channels is
                length 3 for RGB and length 1 for grayscale.
            - The array is of type uint8.
    """</span>
    mode <span class="token operator">=</span> <span class="token string">"L"</span> <span class="token keyword">if</span> as_gray <span class="token keyword">else</span> <span class="token string">"RGB"</span>
    <span class="token keyword">if</span> filepath<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"s3://"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> read_image_from_s3<span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
    <span class="token keyword">return</span> read_image_from_local_disk<span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-2" id="node-2">
        <div class="call-header" onclick="toggleCall(2)">
            <span class="toggle-icon" id="icon-2">‚ñ∂</span>
            
        <span class="function-name">return read_image_from_s3(filepath, mode)</span>
    
            
        <span class="file-info">[image_ops.py:37]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-2" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-2" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(2)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(2)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-2"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-2" oninput="previewComment(2)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">s3_uri:</span> <span style="color: rgb(0, 86, 179);">'s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg'</span></div>
            
                <div><span style="color: #505050;">mode:</span> <span style="color: rgb(0, 86, 179);">'RGB'</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value"><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_0.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_0" data-expanded="false" onclick="toggleImageSize('img_0')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(2)">Show/Hide</button>
                <div class="source-container" id="source-2">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">read_image_from_s3</span><span class="token punctuation">(</span>s3_uri<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> mode<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> RGBImage<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Read an image from S3 using boto.

    Arguments:
        s3_uri: The s3 URI (path with bucket) to read the image from.
        mode: The mode to read the image in (e.g. "L" for grayscale).

    Returns:
        A numpy array representing an image.
            - The array is shaped (height, width, channels) where channels is
                length 3 for RGB and length 1 for grayscale.
            - The array is of type uint8.
    """</span>
    url <span class="token operator">=</span> urlparse<span class="token punctuation">(</span>s3_uri<span class="token punctuation">)</span>
    image_bucket <span class="token operator">=</span> url<span class="token punctuation">.</span>netloc
    image_key <span class="token operator">=</span> url<span class="token punctuation">.</span>path<span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>

    <span class="token comment"># Load the jpg image into memory</span>
    response <span class="token operator">=</span> s3<span class="token punctuation">.</span>get_object<span class="token punctuation">(</span>
        Bucket<span class="token operator">=</span>image_bucket<span class="token punctuation">,</span>
        Key<span class="token operator">=</span>image_key<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    image_bytes <span class="token operator">=</span> response<span class="token punctuation">[</span><span class="token string">"Body"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> imageio<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>image_bytes<span class="token punctuation">,</span> mode<span class="token operator">=</span>mode<span class="token punctuation">)</span>
    <span class="token keyword">return</span> image
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-1" id="node-5">
        <div class="call-header" onclick="toggleCall(5)">
            <span class="toggle-icon" id="icon-5">‚ñº</span>
            
            <span class="method-indicator">[Future]</span> 
        <span class="function-name">bounding_box_inference_results = bbox_future.result()</span>
    
        
            
        <span class="file-info">[_base.py:83]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-5" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-5" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(5)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(5)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-5"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-5" oninput="previewComment(5)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">self:</span> <span style="color: rgb(0, 86, 179);">concurrent.futures._base.Future()</span></div>
            
                <div><span style="color: #505050;">timeout:</span> <span style="color: rgb(0, 86, 179);">None</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (2√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.48,0.26,0.51,0.29,0.45,OTHER_MATERIAL,1920,1080,0.0,6d67e35b-ebc9-4f40-971f-af128b86e11f
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_2.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_2" data-expanded="false" onclick="toggleImageSize('img_2')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(5)">Show/Hide</button>
                <div class="source-container" id="source-5">
                    <pre class="language-python" tabindex="0"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">result</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return the result of the call that the future represents.

        Args:
            timeout: The number of seconds to wait for the result if the future
                isn't done. If None, then there is no limit on the wait time.

        Returns:
            The result of the call that the future represents.

        Raises:
            CancelledError: If the future was cancelled.
            TimeoutError: If the future didn't finish executing before the given
                timeout.
            Exception: If the call raised then that exception will be raised.
        """</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>_condition<span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state <span class="token keyword">in</span> <span class="token punctuation">[</span>CANCELLED<span class="token punctuation">,</span> CANCELLED_AND_NOTIFIED<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_state <span class="token operator">==</span> FINISHED<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> self<span class="token punctuation">.</span>__get_result<span class="token punctuation">(</span><span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>_condition<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>

                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state <span class="token keyword">in</span> <span class="token punctuation">[</span>CANCELLED<span class="token punctuation">,</span> CANCELLED_AND_NOTIFIED<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_state <span class="token operator">==</span> FINISHED<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> self<span class="token punctuation">.</span>__get_result<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> TimeoutError<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># Break a reference cycle with the exception in self._exception</span>
            self <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-1" id="node-7">
        <div class="call-header" onclick="toggleCall(7)">
            <span class="toggle-icon" id="icon-7">‚ñº</span>
            
            <span class="method-indicator">[Future]</span> 
        <span class="function-name">box_base_segmentation_inference_results = segmentation_future.result()</span>
    
        
            
        <span class="file-info">[_base.py:84]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-7" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-7" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(7)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(7)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-7"><h2>Segmentation Model</h2>
<p>The segmentation model attempts to find the <em>base</em> of the box. The base of the box is the rectangular region facing the camera (excluding the flaps).</p>
<p>The idea here is if we can segment this region, we can measure 2 of 3 box dimensions (length and width basically).</p>
<p>In this example model detection you'll see two <code>BOX_BASE</code> detections, one of which is a false positive (the flap).</p>
<p>As we'll see, the weight estimation workflow will end up only using the larger one and discard the smaller one.</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-7" oninput="previewComment(7)" placeholder="Type your comment here. Markdown is supported." data-comment="## Segmentation Model

The segmentation model attempts to find the _base_ of the box. The base of the box is the rectangular region facing the camera (excluding the flaps).

The idea here is if we can segment this region, we can measure 2 of 3 box dimensions (length and width basically).

In this example model detection you'll see two `BOX_BASE` detections, one of which is a false positive (the flap).

As we'll see, the weight estimation workflow will end up only using the larger one and discard the smaller one."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">self:</span> <span style="color: rgb(0, 86, 179);">concurrent.futures._base.Future()</span></div>
            
                <div><span style="color: #505050;">timeout:</span> <span style="color: rgb(0, 86, 179);">None</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_3.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_3" data-expanded="true" onclick="toggleImageSize('img_3')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(7)">Show/Hide</button>
                <div class="source-container" id="source-7">
                    <pre class="language-python" tabindex="0"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">result</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return the result of the call that the future represents.

        Args:
            timeout: The number of seconds to wait for the result if the future
                isn't done. If None, then there is no limit on the wait time.

        Returns:
            The result of the call that the future represents.

        Raises:
            CancelledError: If the future was cancelled.
            TimeoutError: If the future didn't finish executing before the given
                timeout.
            Exception: If the call raised then that exception will be raised.
        """</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>_condition<span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state <span class="token keyword">in</span> <span class="token punctuation">[</span>CANCELLED<span class="token punctuation">,</span> CANCELLED_AND_NOTIFIED<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_state <span class="token operator">==</span> FINISHED<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> self<span class="token punctuation">.</span>__get_result<span class="token punctuation">(</span><span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>_condition<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>

                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state <span class="token keyword">in</span> <span class="token punctuation">[</span>CANCELLED<span class="token punctuation">,</span> CANCELLED_AND_NOTIFIED<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_state <span class="token operator">==</span> FINISHED<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> self<span class="token punctuation">.</span>__get_result<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> TimeoutError<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># Break a reference cycle with the exception in self._exception</span>
            self <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-1" id="node-9">
        <div class="call-header" onclick="toggleCall(9)">
            <span class="toggle-icon" id="icon-9">‚ñº</span>
            
        <span class="function-name">weight_df = weight_model.run_weight_inference_for_dataframes(bounding_box_inference_results,
                box_base_segmentation_inference_results)</span>
    
            
        <span class="file-info">[model.py:89-92]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-9" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-9" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(9)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(9)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-9"><p>This function creates a dataframe of <code>CARDBOARD</code> rows (from the cardboard detection model) with new columns attached</p>
<ul>
<li><code>box_length_cm</code></li>
<li><code>box_width_cm</code></li>
<li><code>box_height_cm</code></li>
<li><code>surface_area</code> (which is in cm<sup>3</sup>)</li>
</ul>
<p>These are the <code>surface area features</code>. The first 3 values are used to calculate the 4th.</p>
<p>Finally, the surface area is used to predict a final new column, the <code>weight</code> (grams).</p>
<p>Note the <code>weight</code> column will be <code>nan</code> for non-CARDBOARD columns.</p>
<p>At a high level we estimate the height using the depth map.</p>
<p>We estimate the box_width and box_length using the <code>BOX_BASE</code> segmentation.</p>
<p>Since an image can have multiple <code>CARDBOARD</code> rows we use <code>discordant_pairs</code> to match up the <code>CARDBOARD</code> boxes (from one YOLO model) with the <code>BOX_BASE</code> segmentations (from the second YOLO model).</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-9" oninput="previewComment(9)" placeholder="Type your comment here. Markdown is supported." data-comment="This function creates a dataframe of `CARDBOARD` rows (from the cardboard detection model) with new columns attached

- `box_length_cm`
- `box_width_cm`
- `box_height_cm`
- `surface_area` (which is in cm&lt;sup&gt;3&lt;/sup&gt;)

These are the `surface area features`. The first 3 values are used to calculate the 4th.

Finally, the surface area is used to predict a final new column, the `weight` (grams).

Note the `weight` column will be `nan` for non-CARDBOARD columns.

At a high level we estimate the height using the depth map.

We estimate the box_width and box_length using the `BOX_BASE` segmentation.

Since an image can have multiple `CARDBOARD` rows we use `discordant_pairs` to match up the `CARDBOARD` boxes (from one YOLO model) with the `BOX_BASE` segmentations (from the second YOLO model).

"></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">cardboard_box_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.48,0.26,0.51,0.29,0.45,OTHER_MATERIAL,1920,1080,0.0,6d67e35b-ebc9-4f40-971f-af128b86e11f
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_4.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_4" data-expanded="false" onclick="toggleImageSize('img_4')">
                             </div></span></div>
            
                <div><span style="color: #505050;">box_base_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_5.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_5" data-expanded="false" onclick="toggleImageSize('img_5')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (1√ó20) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id,box_length_cm,box_width_cm,box_height_cm,device_id,polygon_coordinates,has_depth_map,surface_area,bbox_area,weight
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,25.67,28.96,26.59,SCN-011,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,4392.56,0.2,325.34
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_48.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_48" data-expanded="true" onclick="toggleImageSize('img_48')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(9)">Show/Hide</button>
                <div class="source-container" id="source-9">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">run_weight_inference_for_dataframes</span><span class="token punctuation">(</span>
    cardboard_box_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
    box_base_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Run weight inference on cardboard box and box base dataframes.

    Args:
        cardboard_box_df: DataFrame containing cardboard box detections.
        box_base_df: DataFrame containing box base detections.

    Returns:
        DataFrame with computed surface area features and weight estimates.
    """</span>
    result_df <span class="token operator">=</span> compute_surface_area_features_for_dataframes<span class="token punctuation">(</span>
        cardboard_box_df<span class="token punctuation">,</span> box_base_df
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> result_df<span class="token punctuation">.</span>empty<span class="token punctuation">:</span>
        result_df<span class="token punctuation">[</span><span class="token string">"weight"</span><span class="token punctuation">]</span> <span class="token operator">=</span> result_df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>
            <span class="token keyword">lambda</span> row<span class="token punctuation">:</span> utils<span class="token punctuation">.</span>estimate_weight_from_surface_area<span class="token punctuation">(</span>
                row<span class="token punctuation">.</span>device_id<span class="token punctuation">,</span> row<span class="token punctuation">.</span>surface_area
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            axis<span class="token operator">=</span><span class="token string">"columns"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> result_df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-2" id="node-10">
        <div class="call-header" onclick="toggleCall(10)">
            <span class="toggle-icon" id="icon-10">‚ñº</span>
            
        <span class="function-name">result_df = compute_surface_area_features_for_dataframes(cardboard_box_df, box_base_df)</span>
    
            
        <span class="file-info">[model.py:42-44]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-10" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-10" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(10)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(10)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-10"><p>This is the function that creates the columns:</p>
<ul>
<li><code>box_length_cm</code></li>
<li><code>box_width_cm</code></li>
<li><code>box_height_cm</code></li>
<li><code>surface_area</code></li>
</ul>
<p>It also creates <code>bbox_area</code> which was used to compare two regression models for weight estimation accuracy:</p>
<ul>
<li>bounding box area regression</li>
<li>surface area regression</li>
</ul>
<p>Surface area turned out to be more accurate.</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-10" oninput="previewComment(10)" placeholder="Type your comment here. Markdown is supported." data-comment="This is the function that creates the columns:

- `box_length_cm`
- `box_width_cm`
- `box_height_cm`
- `surface_area`

It also creates `bbox_area` which was used to compare two regression models for weight estimation accuracy:

- bounding box area regression
- surface area regression


Surface area turned out to be more accurate."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">cardboard_box_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.48,0.26,0.51,0.29,0.45,OTHER_MATERIAL,1920,1080,0.0,6d67e35b-ebc9-4f40-971f-af128b86e11f
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_6.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_6" data-expanded="false" onclick="toggleImageSize('img_6')">
                             </div></span></div>
            
                <div><span style="color: #505050;">box_base_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_7.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_7" data-expanded="false" onclick="toggleImageSize('img_7')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (1√ó19) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id,box_length_cm,box_width_cm,box_height_cm,device_id,polygon_coordinates,has_depth_map,surface_area,bbox_area
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,25.67,28.96,26.59,SCN-011,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,4392.56,0.2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_47.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_47" data-expanded="false" onclick="toggleImageSize('img_47')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(10)">Show/Hide</button>
                <div class="source-container" id="source-10">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">compute_surface_area_features_for_dataframes</span><span class="token punctuation">(</span>
    cardboard_box_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
    box_base_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Compute surface area features from cardboard box and box base dataframes.

    Args:
        cardboard_box_df: DataFrame containing cardboard box detections.
        box_base_df: DataFrame containing box base detections.

    Returns:
        DataFrame with computed surface area and bounding box area features.
    """</span>
    cardboard_box_df <span class="token operator">=</span> cardboard_box_df<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">'class_name == "CARDBOARD"'</span><span class="token punctuation">)</span>
    discordant_pairs <span class="token operator">=</span> machine_learning<span class="token punctuation">.</span>dataframe_ops<span class="token punctuation">.</span>find_discordant_pairs<span class="token punctuation">(</span>
        cardboard_box_df<span class="token punctuation">,</span>
        box_base_df<span class="token punctuation">,</span>
        iou_threshold<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    surface_area_features <span class="token operator">=</span> utils<span class="token punctuation">.</span>get_surface_area_features_for_discordant_pairs_df<span class="token punctuation">(</span>
        discordant_pairs
    <span class="token punctuation">)</span>

    result_df <span class="token operator">=</span> utils<span class="token punctuation">.</span>compute_surface_area_and_bbox_area<span class="token punctuation">(</span>
        cardboard_box_df<span class="token punctuation">,</span>
        surface_area_features<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> result_df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-3" id="node-11">
        <div class="call-header" onclick="toggleCall(11)">
            <span class="toggle-icon" id="icon-11">‚ñº</span>
            
        <span class="function-name">discordant_pairs = machine_learning.dataframe_ops.find_discordant_pairs(cardboard_box_df,
        box_base_df,
        iou_threshold=0.05)</span>
    
            
        <span class="file-info">[dataframe_ops.py:121-125]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-11" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-11" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(11)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(11)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-11"><p>This function matches at most one cardboard box detection to at most one box base segmentation.</p>
<p>Since in this example there are two box_base segmentations, the one with highest IOU with the cardboard box is selected.</p>
<p>This is good because it turns out to be more accurate.</p>
<p>Track matches with the <code>group_id</code> column in the return DataFrame.</p>
<p>If you look at the return image, the matched group <code>0451</code> is matching the big <code>BOX_BASE</code> segmentation and the <code>CARDBOARD</code> detection.</p>
<p>The image uses yellow segmentation which is a little confusing.</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-11" oninput="previewComment(11)" placeholder="Type your comment here. Markdown is supported." data-comment="This function matches at most one cardboard box detection to at most one box base segmentation.

Since in this example there are two box_base segmentations, the one with highest IOU with the cardboard box is selected.

This is good because it turns out to be more accurate.

Track matches with the `group_id` column in the return DataFrame.

If you look at the return image, the matched group `0451` is matching the big `BOX_BASE` segmentation and the `CARDBOARD` detection.

The image uses yellow segmentation which is a little confusing."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">alpha_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_8.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_8" data-expanded="false" onclick="toggleImageSize('img_8')">
                             </div></span></div>
            
                <div><span style="color: #505050;">beta_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_9.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_9" data-expanded="false" onclick="toggleImageSize('img_9')">
                             </div></span></div>
            
                <div><span style="color: #505050;">label_model_name:</span> <span style="color: rgb(0, 86, 179);">'alpha'</span></div>
            
                <div><span style="color: #505050;">inference_model_name:</span> <span style="color: rgb(0, 86, 179);">'beta'</span></div>
            
                <div><span style="color: #505050;">iou_threshold:</span> <span style="color: rgb(0, 86, 179);">0.05</span></div>
            
                <div><span style="color: #505050;">allow_multi_matching:</span> <span style="color: rgb(0, 86, 179);">False</span></div>
            
                <div><span style="color: #505050;">parallel:</span> <span style="color: rgb(0, 86, 179);">True</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (3√ó15) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,image_height,image_width,score,model_name,polygon_coordinates,is_segmentation,group_id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,CARDBOARD,0.43,0.16,0.75,0.79,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,1080,1920,0.96,alpha,,,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.43,0.29,0.7,0.79,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402,1080,1920,0.96,beta,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.52,0.15,0.76,0.47,0.07,df78826a-e1ca-4191-b510-a206c847f1f2,1080,1920,0.42,beta,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,a1c95253-9b5e-4276-abc0-848d2179ba73
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_38.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_38" data-expanded="true" onclick="toggleImageSize('img_38')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(11)">Show/Hide</button>
                <div class="source-container" id="source-11">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">find_discordant_pairs</span><span class="token punctuation">(</span>
    alpha_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
    beta_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
    label_model_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"alpha"</span><span class="token punctuation">,</span>
    inference_model_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"beta"</span><span class="token punctuation">,</span>
    iou_threshold<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    allow_multi_matching<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    parallel<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Find discordant pairs between two dataframes.

    This is a wrapper for InferenceRunner.find_discordant_pairs.

    The original code assumed you would want to run inference before
    finding discordant pairs.

    In practice the way we used the code would be to compare two existing
    dataframes (either of labels and inferences or just inferences).

    This method makes that process as easy as possible without
    changing the existing implementation.

    Arguments:
        alpha_df: A pandas dataframe.
        beta_df: A pandas dataframe.
        label_model_name: A string for the ground truth labels.
        inference_model_name: A string for the inference labels.
        iou_threshold: A float between 0 and 1.
        allow_multi_matching: A boolean. If True, allow multiple inferences
            per label.
        parallel: A boolean. If True, run matching in parallel.

    Returns:
        A pandas dataframe with discordant pairs.

    Raises:
        ValueError: If either dataframe is empty.
    """</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>alpha_df<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>beta_df<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Discordant pairs cannot be found with any empty dataframes."</span><span class="token punctuation">)</span>

    ensure_id<span class="token punctuation">(</span>alpha_df<span class="token punctuation">)</span>
    ensure_id<span class="token punctuation">(</span>beta_df<span class="token punctuation">)</span>

    alpha_df <span class="token operator">=</span> alpha_df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    beta_df <span class="token operator">=</span> beta_df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Set area columns if not set.</span>
    machine_learning<span class="token punctuation">.</span>bounding_box_ops<span class="token punctuation">.</span>set_area_column<span class="token punctuation">(</span>alpha_df<span class="token punctuation">)</span>
    machine_learning<span class="token punctuation">.</span>bounding_box_ops<span class="token punctuation">.</span>set_area_column<span class="token punctuation">(</span>beta_df<span class="token punctuation">)</span>

    <span class="token comment"># Convert to evaluation format</span>
    alpha_df <span class="token operator">=</span> prepare_dataframe_for_evaluation<span class="token punctuation">(</span>alpha_df<span class="token punctuation">)</span>
    beta_df <span class="token operator">=</span> prepare_dataframe_for_evaluation<span class="token punctuation">(</span>beta_df<span class="token punctuation">)</span>

    <span class="token comment"># Set model_name columns if not set.</span>
    <span class="token keyword">if</span> <span class="token string">"model_name"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> alpha_df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        alpha_df<span class="token punctuation">[</span><span class="token string">"model_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> label_model_name

    <span class="token keyword">if</span> <span class="token string">"model_name"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> beta_df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        beta_df<span class="token punctuation">[</span><span class="token string">"model_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> inference_model_name

    model_name_alpha <span class="token operator">=</span> alpha_df<span class="token punctuation">[</span><span class="token string">"model_name"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    model_name_beta <span class="token operator">=</span> beta_df<span class="token punctuation">[</span><span class="token string">"model_name"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment"># Create model_executors</span>
    alpha_model_executor <span class="token operator">=</span> MockModelExecutor<span class="token punctuation">(</span>name<span class="token operator">=</span>model_name_alpha<span class="token punctuation">)</span>
    beta_model_executor <span class="token operator">=</span> MockModelExecutor<span class="token punctuation">(</span>name<span class="token operator">=</span>model_name_beta<span class="token punctuation">)</span>

    combined_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>alpha_df<span class="token punctuation">,</span> beta_df<span class="token punctuation">]</span><span class="token punctuation">)</span>
    combined_df <span class="token operator">=</span> combined_df<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    executors <span class="token operator">=</span> <span class="token punctuation">[</span>alpha_model_executor<span class="token punctuation">,</span> beta_model_executor<span class="token punctuation">]</span>

    <span class="token keyword">return</span> camera<span class="token punctuation">.</span>inference_runner<span class="token punctuation">.</span>InferenceRunner<span class="token punctuation">.</span>find_discordant_pairs<span class="token punctuation">(</span>
        executors<span class="token punctuation">,</span>
        combined_df<span class="token punctuation">,</span>
        iou_threshold<span class="token operator">=</span>iou_threshold<span class="token punctuation">,</span>
        allow_multi_matching<span class="token operator">=</span>allow_multi_matching<span class="token punctuation">,</span>
        parallel<span class="token operator">=</span>parallel<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-12">
        <div class="call-header" onclick="toggleCall(12)">
            <span class="toggle-icon" id="icon-12">‚ñ∂</span>
            
        <span class="function-name">ensure_id(alpha_df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:330]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-12" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-12" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(12)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(12)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-12"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-12" oninput="previewComment(12)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_10.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_10" data-expanded="false" onclick="toggleImageSize('img_10')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_11.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_11" data-expanded="false" onclick="toggleImageSize('img_11')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(12)">Show/Hide</button>
                <div class="source-container" id="source-12">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">ensure_id</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Ensure that each row has a unique ID.

    Arguments:
        df: A pandas dataframe.

    Returns:
        The same dataframe with an id column.
    """</span>

    <span class="token keyword">def</span> <span class="token function">_get_or_set_id</span><span class="token punctuation">(</span>row<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return the ID of the row or return a new ID.

        Arguments:
            row: A pandas series.

        Returns:
            The id of the row.
        """</span>
        existing_id <span class="token operator">=</span> row<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
        str_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>existing_id<span class="token punctuation">)</span>
        <span class="token comment"># hack</span>
        <span class="token keyword">if</span> str_id <span class="token operator">==</span> <span class="token string">"nan"</span> <span class="token keyword">or</span> existing_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            new_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> new_id
        <span class="token keyword">return</span> str_id

    <span class="token keyword">if</span> <span class="token string">"id"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>_get_or_set_id<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-14">
        <div class="call-header" onclick="toggleCall(14)">
            <span class="toggle-icon" id="icon-14">‚ñ∂</span>
            
        <span class="function-name">ensure_id(beta_df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:331]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-14" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-14" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(14)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(14)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-14"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-14" oninput="previewComment(14)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_12.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_12" data-expanded="false" onclick="toggleImageSize('img_12')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_13.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_13" data-expanded="false" onclick="toggleImageSize('img_13')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(14)">Show/Hide</button>
                <div class="source-container" id="source-14">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">ensure_id</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Ensure that each row has a unique ID.

    Arguments:
        df: A pandas dataframe.

    Returns:
        The same dataframe with an id column.
    """</span>

    <span class="token keyword">def</span> <span class="token function">_get_or_set_id</span><span class="token punctuation">(</span>row<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return the ID of the row or return a new ID.

        Arguments:
            row: A pandas series.

        Returns:
            The id of the row.
        """</span>
        existing_id <span class="token operator">=</span> row<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
        str_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>existing_id<span class="token punctuation">)</span>
        <span class="token comment"># hack</span>
        <span class="token keyword">if</span> str_id <span class="token operator">==</span> <span class="token string">"nan"</span> <span class="token keyword">or</span> existing_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            new_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> new_id
        <span class="token keyword">return</span> str_id

    <span class="token keyword">if</span> <span class="token string">"id"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>_get_or_set_id<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-16">
        <div class="call-header" onclick="toggleCall(16)">
            <span class="toggle-icon" id="icon-16">‚ñ∂</span>
            
        <span class="function-name">machine_learning.bounding_box_ops.set_area_column(alpha_df)</span>
    
            
        <span class="file-info">[bounding_box_ops.py:337]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-16" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-16" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(16)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(16)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-16"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-16" oninput="previewComment(16)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_14.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_14" data-expanded="false" onclick="toggleImageSize('img_14')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_15.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_15" data-expanded="false" onclick="toggleImageSize('img_15')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(16)">Show/Hide</button>
                <div class="source-container" id="source-16">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">set_area_column</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Add a column 'area' to the dataframe.

    Arguments:
        df: A pandas dataframe with xmin, ymin, xmax, ymax in any coordinates.

    Returns:
        The same dataframe with an additional column 'area'.
    """</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> df

    df<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">.</span>ymax <span class="token operator">-</span> df<span class="token punctuation">.</span>ymin<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>df<span class="token punctuation">.</span>xmax <span class="token operator">-</span> df<span class="token punctuation">.</span>xmin<span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>df<span class="token punctuation">.</span>area<span class="token punctuation">.</span>isna<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
    df<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>df<span class="token punctuation">.</span>dtypes<span class="token punctuation">[</span><span class="token string">"xmin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-18">
        <div class="call-header" onclick="toggleCall(18)">
            <span class="toggle-icon" id="icon-18">‚ñ∂</span>
            
        <span class="function-name">machine_learning.bounding_box_ops.set_area_column(beta_df)</span>
    
            
        <span class="file-info">[bounding_box_ops.py:338]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-18" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-18" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(18)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(18)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-18"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-18" oninput="previewComment(18)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_16.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_16" data-expanded="false" onclick="toggleImageSize('img_16')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_17.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_17" data-expanded="false" onclick="toggleImageSize('img_17')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(18)">Show/Hide</button>
                <div class="source-container" id="source-18">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">set_area_column</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Add a column 'area' to the dataframe.

    Arguments:
        df: A pandas dataframe with xmin, ymin, xmax, ymax in any coordinates.

    Returns:
        The same dataframe with an additional column 'area'.
    """</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> df

    df<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">.</span>ymax <span class="token operator">-</span> df<span class="token punctuation">.</span>ymin<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>df<span class="token punctuation">.</span>xmax <span class="token operator">-</span> df<span class="token punctuation">.</span>xmin<span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>df<span class="token punctuation">.</span>area<span class="token punctuation">.</span>isna<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
    df<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>df<span class="token punctuation">.</span>dtypes<span class="token punctuation">[</span><span class="token string">"xmin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-20">
        <div class="call-header" onclick="toggleCall(20)">
            <span class="toggle-icon" id="icon-20">‚ñ∂</span>
            
        <span class="function-name">alpha_df = prepare_dataframe_for_evaluation(alpha_df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:341]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-20" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-20" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(20)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(20)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-20"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-20" oninput="previewComment(20)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_18.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_18" data-expanded="false" onclick="toggleImageSize('img_18')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,image_height,image_width,score
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,CARDBOARD,0.43,0.16,0.75,0.79,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,1080,1920,0.96
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_25.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_25" data-expanded="false" onclick="toggleImageSize('img_25')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(20)">Show/Hide</button>
                <div class="source-container" id="source-20">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">prepare_dataframe_for_evaluation</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Ensure the dataframe matches the format expected by the evaluation code.

    Arguments:
        df: A pandas dataframe.

    Returns:
        The same dataframe with modified columns.
    """</span>
    original_df <span class="token operator">=</span> df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    df <span class="token operator">=</span> ensure_normalized_coordinates<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"filename"</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"image_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> original_df<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span>
    <span class="token keyword">elif</span> <span class="token string">"s3_uri"</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"image_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"s3_uri"</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> original_df<span class="token punctuation">[</span><span class="token string">"s3_uri"</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token string">"class"</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"class_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"class"</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> original_df<span class="token punctuation">[</span><span class="token string">"class"</span><span class="token punctuation">]</span>

    ensure_id<span class="token punctuation">(</span>df<span class="token punctuation">)</span>

    columns <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"image_name"</span><span class="token punctuation">,</span>
        <span class="token string">"class_name"</span><span class="token punctuation">,</span>
        <span class="token string">"xmin"</span><span class="token punctuation">,</span>
        <span class="token string">"ymin"</span><span class="token punctuation">,</span>
        <span class="token string">"xmax"</span><span class="token punctuation">,</span>
        <span class="token string">"ymax"</span><span class="token punctuation">,</span>
        <span class="token string">"area"</span><span class="token punctuation">,</span>
        <span class="token string">"id"</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token string">"polygon_coordinates"</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        columns<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"polygon_coordinates"</span><span class="token punctuation">)</span>

    df <span class="token operator">=</span> df<span class="token punctuation">[</span>columns<span class="token punctuation">]</span>

    copy_columns_not_present<span class="token punctuation">(</span>from_df<span class="token operator">=</span>original_df<span class="token punctuation">,</span> to_df<span class="token operator">=</span>df<span class="token punctuation">)</span>

    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-21">
        <div class="call-header" onclick="toggleCall(21)">
            <span class="toggle-icon" id="icon-21">‚ñ∂</span>
            
        <span class="function-name">df = ensure_normalized_coordinates(df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:482]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-21" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-21" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(21)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(21)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-21"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-21" oninput="previewComment(21)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_19.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_19" data-expanded="false" onclick="toggleImageSize('img_19')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_20.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_20" data-expanded="false" onclick="toggleImageSize('img_20')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(21)">Show/Hide</button>
                <div class="source-container" id="source-21">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">ensure_normalized_coordinates</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Run convert_to_normalized_coordinates if needed.

    Arguments:
        df: A pandas dataframe with xmin, ymin, xmax, ymax in any coordinates.

    Returns:
        The same dataframe with normalized coordinates.
    """</span>
    <span class="token keyword">if</span> <span class="token builtin">all</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">==</span> <span class="token builtin">int</span>
            <span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token punctuation">[</span>
                <span class="token string">"xmin"</span><span class="token punctuation">,</span>
                <span class="token string">"xmax"</span><span class="token punctuation">,</span>
                <span class="token string">"ymin"</span><span class="token punctuation">,</span>
                <span class="token string">"ymax"</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> convert_to_normalized_coordinates<span class="token punctuation">(</span>df<span class="token punctuation">,</span> validate_column_types<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-23">
        <div class="call-header" onclick="toggleCall(23)">
            <span class="toggle-icon" id="icon-23">‚ñ∂</span>
            
        <span class="function-name">ensure_id(df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:494]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-23" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-23" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(23)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(23)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-23"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-23" oninput="previewComment(23)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_21.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_21" data-expanded="false" onclick="toggleImageSize('img_21')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_22.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_22" data-expanded="false" onclick="toggleImageSize('img_22')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(23)">Show/Hide</button>
                <div class="source-container" id="source-23">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">ensure_id</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Ensure that each row has a unique ID.

    Arguments:
        df: A pandas dataframe.

    Returns:
        The same dataframe with an id column.
    """</span>

    <span class="token keyword">def</span> <span class="token function">_get_or_set_id</span><span class="token punctuation">(</span>row<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return the ID of the row or return a new ID.

        Arguments:
            row: A pandas series.

        Returns:
            The id of the row.
        """</span>
        existing_id <span class="token operator">=</span> row<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
        str_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>existing_id<span class="token punctuation">)</span>
        <span class="token comment"># hack</span>
        <span class="token keyword">if</span> str_id <span class="token operator">==</span> <span class="token string">"nan"</span> <span class="token keyword">or</span> existing_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            new_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> new_id
        <span class="token keyword">return</span> str_id

    <span class="token keyword">if</span> <span class="token string">"id"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>_get_or_set_id<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-25">
        <div class="call-header" onclick="toggleCall(25)">
            <span class="toggle-icon" id="icon-25">‚ñ∂</span>
            
        <span class="function-name">copy_columns_not_present(from_df=original_df, to_df=df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:512]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-25" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-25" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(25)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(25)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-25"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-25" oninput="previewComment(25)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">from_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_23.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_23" data-expanded="false" onclick="toggleImageSize('img_23')">
                             </div></span></div>
            
                <div><span style="color: #505050;">to_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó8) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,CARDBOARD,0.43,0.16,0.75,0.79,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_24.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_24" data-expanded="false" onclick="toggleImageSize('img_24')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">None</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(25)">Show/Hide</button>
                <div class="source-container" id="source-25">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">copy_columns_not_present</span><span class="token punctuation">(</span>from_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> to_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Transfer all columns not present in to_df from from_df.

    Arguments:
        from_df: A pandas dataframe.
        to_df: A pandas dataframe.
    """</span>
    columns_to_copy <span class="token operator">=</span> from_df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>difference<span class="token punctuation">(</span>to_df<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
    to_df<span class="token punctuation">[</span>columns_to_copy<span class="token punctuation">]</span> <span class="token operator">=</span> from_df<span class="token punctuation">[</span>columns_to_copy<span class="token punctuation">]</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-28">
        <div class="call-header" onclick="toggleCall(28)">
            <span class="toggle-icon" id="icon-28">‚ñ∂</span>
            
        <span class="function-name">beta_df = prepare_dataframe_for_evaluation(beta_df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:342]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-28" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-28" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(28)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(28)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-28"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-28" oninput="previewComment(28)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_26.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_26" data-expanded="false" onclick="toggleImageSize('img_26')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,polygon_coordinates,image_height,image_width,is_segmentation,score
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.43,0.29,0.7,0.79,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",1080,1920,True,0.96
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.52,0.15,0.76,0.47,0.07,df78826a-e1ca-4191-b510-a206c847f1f2,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",1080,1920,True,0.42
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_33.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_33" data-expanded="false" onclick="toggleImageSize('img_33')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(28)">Show/Hide</button>
                <div class="source-container" id="source-28">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">prepare_dataframe_for_evaluation</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Ensure the dataframe matches the format expected by the evaluation code.

    Arguments:
        df: A pandas dataframe.

    Returns:
        The same dataframe with modified columns.
    """</span>
    original_df <span class="token operator">=</span> df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    df <span class="token operator">=</span> ensure_normalized_coordinates<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"filename"</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"image_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> original_df<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span>
    <span class="token keyword">elif</span> <span class="token string">"s3_uri"</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"image_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"s3_uri"</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> original_df<span class="token punctuation">[</span><span class="token string">"s3_uri"</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token string">"class"</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"class_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">"class"</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> original_df<span class="token punctuation">[</span><span class="token string">"class"</span><span class="token punctuation">]</span>

    ensure_id<span class="token punctuation">(</span>df<span class="token punctuation">)</span>

    columns <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"image_name"</span><span class="token punctuation">,</span>
        <span class="token string">"class_name"</span><span class="token punctuation">,</span>
        <span class="token string">"xmin"</span><span class="token punctuation">,</span>
        <span class="token string">"ymin"</span><span class="token punctuation">,</span>
        <span class="token string">"xmax"</span><span class="token punctuation">,</span>
        <span class="token string">"ymax"</span><span class="token punctuation">,</span>
        <span class="token string">"area"</span><span class="token punctuation">,</span>
        <span class="token string">"id"</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token string">"polygon_coordinates"</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        columns<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"polygon_coordinates"</span><span class="token punctuation">)</span>

    df <span class="token operator">=</span> df<span class="token punctuation">[</span>columns<span class="token punctuation">]</span>

    copy_columns_not_present<span class="token punctuation">(</span>from_df<span class="token operator">=</span>original_df<span class="token punctuation">,</span> to_df<span class="token operator">=</span>df<span class="token punctuation">)</span>

    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-29">
        <div class="call-header" onclick="toggleCall(29)">
            <span class="toggle-icon" id="icon-29">‚ñ∂</span>
            
        <span class="function-name">df = ensure_normalized_coordinates(df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:482]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-29" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-29" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(29)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(29)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-29"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-29" oninput="previewComment(29)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_27.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_27" data-expanded="false" onclick="toggleImageSize('img_27')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_28.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_28" data-expanded="false" onclick="toggleImageSize('img_28')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(29)">Show/Hide</button>
                <div class="source-container" id="source-29">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">ensure_normalized_coordinates</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Run convert_to_normalized_coordinates if needed.

    Arguments:
        df: A pandas dataframe with xmin, ymin, xmax, ymax in any coordinates.

    Returns:
        The same dataframe with normalized coordinates.
    """</span>
    <span class="token keyword">if</span> <span class="token builtin">all</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">==</span> <span class="token builtin">int</span>
            <span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token punctuation">[</span>
                <span class="token string">"xmin"</span><span class="token punctuation">,</span>
                <span class="token string">"xmax"</span><span class="token punctuation">,</span>
                <span class="token string">"ymin"</span><span class="token punctuation">,</span>
                <span class="token string">"ymax"</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> convert_to_normalized_coordinates<span class="token punctuation">(</span>df<span class="token punctuation">,</span> validate_column_types<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-31">
        <div class="call-header" onclick="toggleCall(31)">
            <span class="toggle-icon" id="icon-31">‚ñ∂</span>
            
        <span class="function-name">ensure_id(df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:494]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-31" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-31" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(31)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(31)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-31"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-31" oninput="previewComment(31)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_29.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_29" data-expanded="false" onclick="toggleImageSize('img_29')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_30.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_30" data-expanded="false" onclick="toggleImageSize('img_30')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(31)">Show/Hide</button>
                <div class="source-container" id="source-31">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">ensure_id</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Ensure that each row has a unique ID.

    Arguments:
        df: A pandas dataframe.

    Returns:
        The same dataframe with an id column.
    """</span>

    <span class="token keyword">def</span> <span class="token function">_get_or_set_id</span><span class="token punctuation">(</span>row<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return the ID of the row or return a new ID.

        Arguments:
            row: A pandas series.

        Returns:
            The id of the row.
        """</span>
        existing_id <span class="token operator">=</span> row<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
        str_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>existing_id<span class="token punctuation">)</span>
        <span class="token comment"># hack</span>
        <span class="token keyword">if</span> str_id <span class="token operator">==</span> <span class="token string">"nan"</span> <span class="token keyword">or</span> existing_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            new_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> new_id
        <span class="token keyword">return</span> str_id

    <span class="token keyword">if</span> <span class="token string">"id"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>_get_or_set_id<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-33">
        <div class="call-header" onclick="toggleCall(33)">
            <span class="toggle-icon" id="icon-33">‚ñ∂</span>
            
        <span class="function-name">copy_columns_not_present(from_df=original_df, to_df=df)</span>
    
            
        <span class="file-info">[dataframe_ops.py:512]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-33" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-33" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(33)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(33)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-33"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-33" oninput="previewComment(33)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">from_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó13) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,polygon_coordinates,is_segmentation,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.29,0.7,0.79,0.96,BOX_BASE,1920,1080,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.52,0.15,0.76,0.47,0.42,BOX_BASE,1920,1080,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,0.07,df78826a-e1ca-4191-b510-a206c847f1f2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_31.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_31" data-expanded="false" onclick="toggleImageSize('img_31')">
                             </div></span></div>
            
                <div><span style="color: #505050;">to_df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (2√ó9) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,polygon_coordinates
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.43,0.29,0.7,0.79,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]"
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.52,0.15,0.76,0.47,0.07,df78826a-e1ca-4191-b510-a206c847f1f2,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]"
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_32.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_32" data-expanded="false" onclick="toggleImageSize('img_32')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">None</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(33)">Show/Hide</button>
                <div class="source-container" id="source-33">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">copy_columns_not_present</span><span class="token punctuation">(</span>from_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> to_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Transfer all columns not present in to_df from from_df.

    Arguments:
        from_df: A pandas dataframe.
        to_df: A pandas dataframe.
    """</span>
    columns_to_copy <span class="token operator">=</span> from_df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>difference<span class="token punctuation">(</span>to_df<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
    to_df<span class="token punctuation">[</span>columns_to_copy<span class="token punctuation">]</span> <span class="token operator">=</span> from_df<span class="token punctuation">[</span>columns_to_copy<span class="token punctuation">]</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-36">
        <div class="call-header" onclick="toggleCall(36)">
            <span class="toggle-icon" id="icon-36">‚ñ∂</span>
            
        <span class="function-name">return camera.inference_runner.InferenceRunner.find_discordant_pairs(executors,
        combined_df,
        iou_threshold=iou_threshold,
        allow_multi_matching=allow_multi_matching,
        parallel=parallel)</span>
    
            
        <span class="file-info">[inference_runner.py:363-369]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-36" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-36" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(36)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(36)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-36"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-36" oninput="previewComment(36)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">executors:</span> <span style="color: rgb(0, 86, 179);">[&lt;machine_learning.dataframe_ops.MockModelExecutor object at 0x75b108038700&gt;, &lt;machine_learning.dataframe_ops.MockModelExecutor object at 0x75b108038d30&gt;]</span></div>
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (3√ó14) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,image_height,image_width,score,model_name,polygon_coordinates,is_segmentation
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,CARDBOARD,0.43,0.16,0.75,0.79,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,1080,1920,0.96,alpha,,
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.43,0.29,0.7,0.79,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402,1080,1920,0.96,beta,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.52,0.15,0.76,0.47,0.07,df78826a-e1ca-4191-b510-a206c847f1f2,1080,1920,0.42,beta,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_34.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_34" data-expanded="false" onclick="toggleImageSize('img_34')">
                             </div></span></div>
            
                <div><span style="color: #505050;">iou_threshold:</span> <span style="color: rgb(0, 86, 179);">0.05</span></div>
            
                <div><span style="color: #505050;">allow_multi_matching:</span> <span style="color: rgb(0, 86, 179);">False</span></div>
            
                <div><span style="color: #505050;">parallel:</span> <span style="color: rgb(0, 86, 179);">True</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (3√ó15) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,image_height,image_width,score,model_name,polygon_coordinates,is_segmentation,group_id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,CARDBOARD,0.43,0.16,0.75,0.79,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,1080,1920,0.96,alpha,,,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.43,0.29,0.7,0.79,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402,1080,1920,0.96,beta,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.52,0.15,0.76,0.47,0.07,df78826a-e1ca-4191-b510-a206c847f1f2,1080,1920,0.42,beta,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,a1c95253-9b5e-4276-abc0-848d2179ba73
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_37.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_37" data-expanded="false" onclick="toggleImageSize('img_37')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(36)">Show/Hide</button>
                <div class="source-container" id="source-36">
                    <pre class="language-python" tabindex="0"><code class="language-python">    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">find_discordant_pairs</span><span class="token punctuation">(</span>
        executors<span class="token punctuation">:</span> List<span class="token punctuation">[</span>model_executor<span class="token punctuation">.</span>ModelExecutor<span class="token punctuation">]</span><span class="token punctuation">,</span>
        df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
        iou_threshold<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
        allow_multi_matching<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        parallel<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Find discordant pairs between inferences of the same photo.

        Args:
            executors (List[model_executor.ModelExecutor]): list of cv models
            df (pd.DataFrame): dataframe containing the columns image_name,
                model_name, ymin, ymax, xmin, xmax, class_name, score, area
            iou_threshold (float): value between 0 and 1 that represents how
                much area overlap two bounding boxes need to have to be
                considered the same bounding box
            allow_multi_matching (bool): If True, allow multiple inferences to
                be assigned to a single label.
            parallel (bool): whether to run matching in parallel

        Returns:
            pd.DataFrame: dataframe containing the discordant pairs
        """</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>executors<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Expected 2 executors"</span>
        alpha<span class="token punctuation">,</span> beta <span class="token operator">=</span> executors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> executors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name

        df <span class="token operator">=</span> df<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"class_name != 'BACKGROUND'"</span><span class="token punctuation">)</span>

        groups <span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">"image_name"</span><span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>image_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">"""Assign group IDs to one image group.

            Args:
                image_df (pd.DataFrame): DataFrame containing the columns
                    ymin, xmin, ymax, xmax, class_name, model_name, id

            Returns:
                pd.DataFrame: DataFrame with group ids assigned
            """</span>
            <span class="token keyword">return</span> InferenceRunner<span class="token punctuation">.</span>assign_groups<span class="token punctuation">(</span>
                image_df<span class="token punctuation">,</span>
                iou_threshold<span class="token punctuation">,</span>
                alpha<span class="token punctuation">,</span>
                beta<span class="token punctuation">,</span>
                allow_multi_matching<span class="token operator">=</span>allow_multi_matching<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

        <span class="token keyword">if</span> parallel<span class="token punctuation">:</span>
            result <span class="token operator">=</span> parallelize_dataframe_groupby_apply<span class="token punctuation">(</span>groups<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> groups<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>

        <span class="token keyword">return</span> result<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-37">
        <div class="call-header" onclick="toggleCall(37)">
            <span class="toggle-icon" id="icon-37">‚ñ∂</span>
            
        <span class="function-name">result = parallelize_dataframe_groupby_apply(groups, handler)</span>
    
            
        <span class="file-info">[inference_runner.py:202]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-37" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-37" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(37)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(37)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-37"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-37" oninput="previewComment(37)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">grouped:</span> <span style="color: rgb(0, 86, 179);">DataFrameGroupBy(&lt;instance inspection failed: The truth value of a DataFrame is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().&gt;)</span></div>
            
                <div><span style="color: #505050;">func:</span> <span style="color: rgb(0, 86, 179);">function()</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (3√ó15) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,image_height,image_width,score,model_name,polygon_coordinates,is_segmentation,group_id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,CARDBOARD,0.43,0.16,0.75,0.79,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,1080,1920,0.96,alpha,,,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.43,0.29,0.7,0.79,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402,1080,1920,0.96,beta,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.52,0.15,0.76,0.47,0.07,df78826a-e1ca-4191-b510-a206c847f1f2,1080,1920,0.42,beta,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,a1c95253-9b5e-4276-abc0-848d2179ba73
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_36.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_36" data-expanded="false" onclick="toggleImageSize('img_36')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(37)">Show/Hide</button>
                <div class="source-container" id="source-37">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parallelize_dataframe_groupby_apply</span><span class="token punctuation">(</span>
    grouped<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>core<span class="token punctuation">.</span>groupby<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>DataFrameGroupBy<span class="token punctuation">,</span>
    func<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span><span class="token punctuation">[</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">]</span><span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Parallelize application of a function across DataFrameGroupBy objects.

    Args:
        grouped (pd.core.groupby.generic.DataFrameGroupBy): The GroupBy object
            to process.
        func (Callable[[pd.DataFrame], pd.DataFrame]): The function to apply to
            each group.

    Returns:
        pd.DataFrame: A DataFrame resulting from concatenating the results.
    """</span>
    group_keys <span class="token operator">=</span> grouped<span class="token punctuation">.</span>groups<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
        results <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>
            <span class="token keyword">lambda</span> key<span class="token punctuation">:</span> worker<span class="token punctuation">(</span>key<span class="token punctuation">,</span> grouped<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">,</span>
            group_keys<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-0" id="node-38">
        <div class="call-header" onclick="toggleCall(38)">
            <span class="toggle-icon" id="icon-38">‚ñ∂</span>
            
            <span class="method-indicator">[Future]</span> 
        <span class="function-name">return pd.concat(results)</span>
    
        
            
        <span class="file-info">[_base.py:441]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-38" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-38" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(38)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(38)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-38"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-38" oninput="previewComment(38)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">self:</span> <span style="color: rgb(0, 86, 179);">concurrent.futures._base.Future()</span></div>
            
                <div><span style="color: #505050;">timeout:</span> <span style="color: rgb(0, 86, 179);">None</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (3√ó15) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,image_height,image_width,score,model_name,polygon_coordinates,is_segmentation,group_id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,CARDBOARD,0.43,0.16,0.75,0.79,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,1080,1920,0.96,alpha,,,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.43,0.29,0.7,0.79,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402,1080,1920,0.96,beta,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.52,0.15,0.76,0.47,0.07,df78826a-e1ca-4191-b510-a206c847f1f2,1080,1920,0.42,beta,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,a1c95253-9b5e-4276-abc0-848d2179ba73
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_35.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_35" data-expanded="false" onclick="toggleImageSize('img_35')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(38)">Show/Hide</button>
                <div class="source-container" id="source-38">
                    <pre class="language-python" tabindex="0"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">result</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return the result of the call that the future represents.

        Args:
            timeout: The number of seconds to wait for the result if the future
                isn't done. If None, then there is no limit on the wait time.

        Returns:
            The result of the call that the future represents.

        Raises:
            CancelledError: If the future was cancelled.
            TimeoutError: If the future didn't finish executing before the given
                timeout.
            Exception: If the call raised then that exception will be raised.
        """</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>_condition<span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state <span class="token keyword">in</span> <span class="token punctuation">[</span>CANCELLED<span class="token punctuation">,</span> CANCELLED_AND_NOTIFIED<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_state <span class="token operator">==</span> FINISHED<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> self<span class="token punctuation">.</span>__get_result<span class="token punctuation">(</span><span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>_condition<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>

                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state <span class="token keyword">in</span> <span class="token punctuation">[</span>CANCELLED<span class="token punctuation">,</span> CANCELLED_AND_NOTIFIED<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_state <span class="token operator">==</span> FINISHED<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> self<span class="token punctuation">.</span>__get_result<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> TimeoutError<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># Break a reference cycle with the exception in self._exception</span>
            self <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-3" id="node-43">
        <div class="call-header" onclick="toggleCall(43)">
            <span class="toggle-icon" id="icon-43">‚ñº</span>
            
        <span class="function-name">surface_area_features = utils.get_surface_area_features_for_discordant_pairs_df(discordant_pairs)</span>
    
            
        <span class="file-info">[utils.py:127-129]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-43" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-43" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(43)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(43)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-43"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-43" oninput="previewComment(43)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">discordant_pairs:</span> <span style="color: rgb(0, 86, 179);">DataFrame (3√ó15) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,class_name,xmin,ymin,xmax,ymax,area,id,image_height,image_width,score,model_name,polygon_coordinates,is_segmentation,group_id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,CARDBOARD,0.43,0.16,0.75,0.79,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,1080,1920,0.96,alpha,,,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.43,0.29,0.7,0.79,0.14,723a7cdc-6f54-4953-8cc8-68a6a0084402,1080,1920,0.96,beta,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,0451f9af-5709-4911-ba73-b45fc69b64f8
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,BOX_BASE,0.52,0.15,0.76,0.47,0.07,df78826a-e1ca-4191-b510-a206c847f1f2,1080,1920,0.42,beta,"[(0.5776041666666667, 0.1712962962962963), (0.759375, 0.33796296296296297), (0.759375, 0.3398148148148148), (0.7229166666666667, 0.4388888888888889), (0.7166666666666667, 0.4546296296296296), (0.7041666666666667, 0.48333333333333334), (0.521875, 0.48333333333333334), (0.521875, 0.28055555555555556), (0.565625, 0.1712962962962963)]",True,a1c95253-9b5e-4276-abc0-848d2179ba73
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_39.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_39" data-expanded="false" onclick="toggleImageSize('img_39')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">{'box_length_cm': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': 25.671628909271057}, 'box_width_cm': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': 28.960996182914716}, 'box_height_cm': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': 26.5922}, 'device_id': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': 'SCN-011'}, 'polygon_coordinates': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': [(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]}, 'has_depth_map': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': True}}</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(43)">Show/Hide</button>
                <div class="source-container" id="source-43">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_surface_area_features_for_discordant_pairs_df</span><span class="token punctuation">(</span>
    discordant_pairs<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Get surface area features from discordant pairs DataFrame.

    Args:
        discordant_pairs: DataFrame containing discordant detection pairs.

    Returns:
        Dictionary mapping feature names to row ID mappings.
    """</span>
    weight_features <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    depth_maps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> _<span class="token punctuation">,</span> group_df <span class="token keyword">in</span> discordant_pairs<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">"group_id"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        box_base <span class="token operator">=</span> group_df<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"class_name == 'BOX_BASE'"</span><span class="token punctuation">)</span>
        cardboard_box <span class="token operator">=</span> group_df<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">'class_name == "CARDBOARD"'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cardboard_box<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        row <span class="token operator">=</span> cardboard_box<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> row<span class="token punctuation">.</span>image_name <span class="token keyword">not</span> <span class="token keyword">in</span> depth_maps<span class="token punctuation">:</span>
            depth_maps<span class="token punctuation">[</span>row<span class="token punctuation">.</span>image_name<span class="token punctuation">]</span> <span class="token operator">=</span> try_load_depth_map_from_s3<span class="token punctuation">(</span>row<span class="token punctuation">.</span>image_name<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>box_base<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            polygon_coordinates <span class="token operator">=</span> box_base<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>polygon_coordinates
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># Fall back to the cardboard box bounding box coordinates</span>
            <span class="token comment"># if no "BOX_BASE" polygon is available.</span>
            polygon_coordinates <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token comment"># clockwise</span>
                <span class="token punctuation">(</span>row<span class="token punctuation">.</span>xmin<span class="token punctuation">,</span> row<span class="token punctuation">.</span>ymin<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>row<span class="token punctuation">.</span>xmax<span class="token punctuation">,</span> row<span class="token punctuation">.</span>ymin<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>row<span class="token punctuation">.</span>xmax<span class="token punctuation">,</span> row<span class="token punctuation">.</span>ymax<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>row<span class="token punctuation">.</span>xmin<span class="token punctuation">,</span> row<span class="token punctuation">.</span>ymax<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>

        features <span class="token operator">=</span> get_surface_area_features<span class="token punctuation">(</span>
            row<span class="token punctuation">.</span>image_name<span class="token punctuation">,</span>
            row<span class="token punctuation">.</span>image_width<span class="token punctuation">,</span>
            row<span class="token punctuation">.</span>image_height<span class="token punctuation">,</span>
            polygon_coordinates<span class="token punctuation">,</span>
            depth_maps<span class="token punctuation">[</span>row<span class="token punctuation">.</span>image_name<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">for</span> feature<span class="token punctuation">,</span> value <span class="token keyword">in</span> features<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            weight_features<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>feature<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span>row<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> value

    <span class="token keyword">return</span> weight_features
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-44">
        <div class="call-header" onclick="toggleCall(44)">
            <span class="toggle-icon" id="icon-44">‚ñº</span>
            
        <span class="function-name">depth_maps[row.image_name] = try_load_depth_map_from_s3(row.image_name)</span>
    
            
        <span class="file-info">[utils.py:219]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-44" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-44" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(44)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(44)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-44"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-44" oninput="previewComment(44)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">image_s3_uri:</span> <span style="color: rgb(0, 86, 179);">'s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg'</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value"><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920), uint16)</div>
                                 <img src="images/img_41.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920), uint16)" class="trace-image" id="trace-img-img_41" data-expanded="true" onclick="toggleImageSize('img_41')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(44)">Show/Hide</button>
                <div class="source-container" id="source-44">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">try_load_depth_map_from_s3</span><span class="token punctuation">(</span>image_s3_uri<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Try to load depth map from S3, returning None if unsuccessful.

    Args:
        image_s3_uri: S3 URI for the image file.

    Returns:
        Loaded depth map array, or None if loading fails.
    """</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> image_s3_uri<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    depth_file <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>image_s3_uri<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".npz"</span><span class="token punctuation">)</span>
    depth_map <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        depth_map <span class="token operator">=</span> load_depth_from_s3<span class="token punctuation">(</span>depth_file<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Could not load depth map from </span><span class="token interpolation"><span class="token punctuation">{</span>depth_file<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> depth_map
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-45">
        <div class="call-header" onclick="toggleCall(45)">
            <span class="toggle-icon" id="icon-45">‚ñ∂</span>
            
        <span class="function-name">depth_map = load_depth_from_s3(depth_file)</span>
    
            
        <span class="file-info">[utils.py:408]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-45" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-45" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(45)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(45)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-45"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-45" oninput="previewComment(45)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">s3_uri:</span> <span style="color: rgb(0, 86, 179);">'s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.npz'</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value"><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920), uint16)</div>
                                 <img src="images/img_40.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920), uint16)" class="trace-image" id="trace-img-img_40" data-expanded="false" onclick="toggleImageSize('img_40')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(45)">Show/Hide</button>
                <div class="source-container" id="source-45">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">load_depth_from_s3</span><span class="token punctuation">(</span>s3_uri<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Download and load a depth map from S3.

    Args:
        s3_uri (str): S3 URI or key for the depth file

    Returns:
        np.ndarray: Loaded depth map

    Raises:
        ValueError: If there is an error loading the depth map
    """</span>
    bucket<span class="token punctuation">,</span> key <span class="token operator">=</span> parse_s3_uri<span class="token punctuation">(</span>s3_uri<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s3 <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">"s3"</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> s3<span class="token punctuation">.</span>get_object<span class="token punctuation">(</span>Bucket<span class="token operator">=</span>bucket<span class="token punctuation">,</span> Key<span class="token operator">=</span>key<span class="token punctuation">)</span>
        file_content <span class="token operator">=</span> response<span class="token punctuation">[</span><span class="token string">"Body"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>file_content<span class="token punctuation">)</span><span class="token punctuation">,</span> allow_pickle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"depth"</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error loading depth map from </span><span class="token interpolation"><span class="token punctuation">{</span>s3_uri<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-0" id="node-46">
        <div class="call-header" onclick="toggleCall(46)">
            <span class="toggle-icon" id="icon-46">‚ñ∂</span>
            
        <span class="function-name">bucket, key = parse_s3_uri(s3_uri)</span>
    
            
        <span class="file-info">[utils.py:383]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-46" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-46" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(46)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(46)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-46"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-46" oninput="previewComment(46)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">s3_uri:</span> <span style="color: rgb(0, 86, 179);">'s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.npz'</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">('scanner-data.us-west-2', 'SCN-011/2025/07/01/15/36/32-102661_0.npz')</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(46)">Show/Hide</button>
                <div class="source-container" id="source-46">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_s3_uri</span><span class="token punctuation">(</span>s3_uri<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Parse an S3 URI or key into bucket and key components.

    Args:
        s3_uri (str): Either a full S3 URI (s3://bucket/key) or just a key

    Returns:
        Tuple[str, str]: bucket and key
    """</span>
    <span class="token keyword">if</span> s3_uri<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"s3://"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Parse S3 URI into bucket and key</span>
        bucket<span class="token punctuation">,</span> key <span class="token operator">=</span> s3_uri<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"s3://"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Treat s3_uri as a key in the default bucket</span>
        bucket<span class="token punctuation">,</span> key <span class="token operator">=</span> consts<span class="token punctuation">.</span>DEFAULT_BUCKET<span class="token punctuation">,</span> s3_uri
    <span class="token keyword">return</span> bucket<span class="token punctuation">,</span> key
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-4" id="node-50">
        <div class="call-header" onclick="toggleCall(50)">
            <span class="toggle-icon" id="icon-50">‚ñº</span>
            
        <span class="function-name">features = get_surface_area_features(row.image_name,
            row.image_width,
            row.image_height,
            polygon_coordinates,
            depth_maps[row.image_name])</span>
    
            
        <span class="file-info">[utils.py:234-240]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-50" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-50" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(50)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(50)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-50"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-50" oninput="previewComment(50)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">image_name:</span> <span style="color: rgb(0, 86, 179);">'s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg'</span></div>
            
                <div><span style="color: #505050;">image_width:</span> <span style="color: rgb(0, 86, 179);">1920</span></div>
            
                <div><span style="color: #505050;">image_height:</span> <span style="color: rgb(0, 86, 179);">1080</span></div>
            
                <div><span style="color: #505050;">polygon_coordinates:</span> <span style="color: rgb(0, 86, 179);">[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]</span></div>
            
                <div><span style="color: #505050;">depth_map:</span> <span style="color: rgb(0, 86, 179);"><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920), uint16)</div>
                                 <img src="images/img_42.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920), uint16)" class="trace-image" id="trace-img-img_42" data-expanded="false" onclick="toggleImageSize('img_42')">
                             </div></span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">{'box_length_cm': 25.671628909271057, 'box_width_cm': 28.960996182914716, 'box_height_cm': 26.5922, 'device_id': 'SCN-011', 'polygon_coordinates': [(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)], 'has_depth_map': True}</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(50)">Show/Hide</button>
                <div class="source-container" id="source-50">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_surface_area_features</span><span class="token punctuation">(</span>
    image_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    image_width<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    image_height<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    polygon_coordinates<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    depth_map<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>np<span class="token punctuation">.</span>ndarray<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Add weight estimate using the cardboard weight feature creator."""</span>
    device_id <span class="token operator">=</span> infer_device_id<span class="token punctuation">(</span>image_name<span class="token punctuation">)</span>

    box_height_cm <span class="token operator">=</span> calculate_height_from_depth_map<span class="token punctuation">(</span>
        depth_map<span class="token punctuation">,</span> polygon_coordinates<span class="token punctuation">,</span> device_id
    <span class="token punctuation">)</span>

    <span class="token keyword">if</span> polygon_coordinates <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        dimensions <span class="token operator">=</span> calculate_dimensions_from_polygon<span class="token punctuation">(</span>
            polygon_coordinates<span class="token punctuation">,</span> image_height<span class="token punctuation">,</span> image_width<span class="token punctuation">,</span> box_height_cm<span class="token punctuation">,</span> device_id
        <span class="token punctuation">)</span>
        features <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token operator">**</span>dimensions<span class="token punctuation">,</span>
            <span class="token string">"device_id"</span><span class="token punctuation">:</span> device_id<span class="token punctuation">,</span>
            <span class="token string">"polygon_coordinates"</span><span class="token punctuation">:</span> polygon_coordinates<span class="token punctuation">,</span>
            <span class="token string">"has_depth_map"</span><span class="token punctuation">:</span> depth_map <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        features <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"box_length_cm"</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span>
            <span class="token string">"box_width_cm"</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span>
            <span class="token string">"box_height_cm"</span><span class="token punctuation">:</span> box_height_cm<span class="token punctuation">,</span>
            <span class="token string">"device_id"</span><span class="token punctuation">:</span> device_id<span class="token punctuation">,</span>
            <span class="token string">"polygon_coordinates"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
            <span class="token string">"has_depth_map"</span><span class="token punctuation">:</span> depth_map <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">return</span> features
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-51">
        <div class="call-header" onclick="toggleCall(51)">
            <span class="toggle-icon" id="icon-51">‚ñ∂</span>
            
        <span class="function-name">device_id = infer_device_id(image_name)</span>
    
            
        <span class="file-info">[utils.py:169]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-51" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-51" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(51)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(51)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-51"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-51" oninput="previewComment(51)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">s3_uri:</span> <span style="color: rgb(0, 86, 179);">'s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg'</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">'SCN-011'</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(51)">Show/Hide</button>
                <div class="source-container" id="source-51">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">infer_device_id</span><span class="token punctuation">(</span>s3_uri<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Infer device ID from S3 URI path.

    Args:
        s3_uri: S3 URI string.

    Returns:
        Device ID extracted from the URI path.
    """</span>
    key <span class="token operator">=</span> s3_uri<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/scanner-data.us-west-2/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    split <span class="token operator">=</span> key<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-53">
        <div class="call-header" onclick="toggleCall(53)">
            <span class="toggle-icon" id="icon-53">‚ñº</span>
            
        <span class="function-name">box_height_cm = calculate_height_from_depth_map(depth_map, polygon_coordinates, device_id)</span>
    
            
        <span class="file-info">[utils.py:171-173]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-53" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-53" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(53)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(53)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-53"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-53" oninput="previewComment(53)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">depth_map:</span> <span style="color: rgb(0, 86, 179);"><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920), uint16)</div>
                                 <img src="images/img_43.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920), uint16)" class="trace-image" id="trace-img-img_43" data-expanded="false" onclick="toggleImageSize('img_43')">
                             </div></span></div>
            
                <div><span style="color: #505050;">polygon_coordinates:</span> <span style="color: rgb(0, 86, 179);">[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]</span></div>
            
                <div><span style="color: #505050;">device_id:</span> <span style="color: rgb(0, 86, 179);">'SCN-011'</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">26.5922</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(53)">Show/Hide</button>
                <div class="source-container" id="source-53">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calculate_height_from_depth_map</span><span class="token punctuation">(</span>
    depth_map<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>np<span class="token punctuation">.</span>ndarray<span class="token punctuation">]</span><span class="token punctuation">,</span>
    polygon_coordinates<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    device_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Calculate height from depth map using polygon coordinates and device ID.

    Args:
        depth_map: Depth map array, or None if not available.
        polygon_coordinates: List of polygon coordinate tuples.
        device_id: Device identifier for calibration parameters.

    Returns:
        Calculated height in centimeters, or None if depth map unavailable.
    """</span>
    <span class="token keyword">if</span> depth_map <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> polygon_coordinates <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        box_height_in_depth_map_terms <span class="token operator">=</span> get_object_height<span class="token punctuation">(</span>
            polygon_coordinates<span class="token punctuation">,</span>
            depth_map<span class="token punctuation">,</span>
            device_id<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> estimate_height_in_cm_from_depth_map_height<span class="token punctuation">(</span>
            box_height_in_depth_map_terms
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-0" id="node-54">
        <div class="call-header" onclick="toggleCall(54)">
            <span class="toggle-icon" id="icon-54">‚ñº</span>
            
        <span class="function-name">box_height_in_depth_map_terms = get_object_height(polygon_coordinates,
            depth_map,
            device_id)</span>
    
            
        <span class="file-info">[utils.py:53-57]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-54" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-54" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(54)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(54)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-54"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-54" oninput="previewComment(54)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">segmentation_mask:</span> <span style="color: rgb(0, 86, 179);">[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]</span></div>
            
                <div><span style="color: #505050;">depth_map:</span> <span style="color: rgb(0, 86, 179);"><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920), uint16)</div>
                                 <img src="images/img_44.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920), uint16)" class="trace-image" id="trace-img-img_44" data-expanded="false" onclick="toggleImageSize('img_44')">
                             </div></span></div>
            
                <div><span style="color: #505050;">device_id:</span> <span style="color: rgb(0, 86, 179);">'SCN-011'</span></div>
            
                <div><span style="color: #505050;">normalize:</span> <span style="color: rgb(0, 86, 179);">False</span></div>
            
                <div><span style="color: #505050;">percentile:</span> <span style="color: rgb(0, 86, 179);">20.0</span></div>
            
                <div><span style="color: #505050;">min_valid_depth:</span> <span style="color: rgb(0, 86, 179);">0.1</span></div>
            
                <div><span style="color: #505050;">max_valid_depth:</span> <span style="color: rgb(0, 86, 179);">10000.0</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">295.25</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(54)">Show/Hide</button>
                <div class="source-container" id="source-54">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_object_height</span><span class="token punctuation">(</span>
    segmentation_mask<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span>
    depth_map<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span>
    device_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    normalize<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    percentile<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">20.0</span><span class="token punctuation">,</span>
    min_valid_depth<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
    max_valid_depth<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">10000.0</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Calculate object height from segmentation mask and depth map.

    Args:
        segmentation_mask: Array of mask coordinates.
        depth_map: Depth map array.
        device_id: Device identifier for empty belt depth lookup.
        normalize: Whether to normalize the height by empty belt depth.
        percentile: Percentile value for depth calculation.
        min_valid_depth: Minimum valid depth value for filtering.
        max_valid_depth: Maximum valid depth value for filtering.

    Returns:
        Object height value.

    Raises:
        ValueError: If inputs are invalid or no valid depth values found.
    """</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> segmentation_mask<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Segmentation mask cannot be empty"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> depth_map<span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Depth map cannot be empty"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> device_id <span class="token keyword">not</span> <span class="token keyword">in</span> consts<span class="token punctuation">.</span>EMPTY_BELT_DEPTH<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Unknown device_id: </span><span class="token interpolation"><span class="token punctuation">{</span>device_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    h<span class="token punctuation">,</span> w <span class="token operator">=</span> depth_map<span class="token punctuation">.</span>shape

    mask <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>segmentation_mask<span class="token punctuation">)</span>
    mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> w<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> w <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> h <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    binary_mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>depth_map<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>binary_mask<span class="token punctuation">,</span> <span class="token punctuation">[</span>mask<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> cv2<span class="token punctuation">.</span>error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Invalid segmentation mask coordinates: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    depth_values <span class="token operator">=</span> depth_map<span class="token punctuation">[</span>binary_mask <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>depth_values<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"No pixels found within segmentation mask"</span><span class="token punctuation">)</span>

    valid_depth_values <span class="token operator">=</span> filter_invalid_depths<span class="token punctuation">(</span>
        depth_values<span class="token punctuation">,</span> min_valid_depth<span class="token punctuation">,</span> max_valid_depth
    <span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valid_depth_values<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"No valid depth values found within segmentation mask"</span><span class="token punctuation">)</span>

    object_depth <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>valid_depth_values<span class="token punctuation">,</span> percentile<span class="token punctuation">)</span><span class="token punctuation">)</span>

    empty_belt_depth <span class="token operator">=</span> consts<span class="token punctuation">.</span>EMPTY_BELT_DEPTH<span class="token punctuation">[</span>device_id<span class="token punctuation">]</span>
    object_height <span class="token operator">=</span> empty_belt_depth <span class="token operator">-</span> object_depth

    <span class="token keyword">if</span> normalize<span class="token punctuation">:</span>
        <span class="token keyword">if</span> empty_belt_depth <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Cannot normalize: empty belt depth is zero"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> object_height <span class="token operator">/</span> empty_belt_depth
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> object_height
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-1" id="node-55">
        <div class="call-header" onclick="toggleCall(55)">
            <span class="toggle-icon" id="icon-55">‚ñ∂</span>
            
        <span class="function-name">valid_depth_values = filter_invalid_depths(depth_values, min_valid_depth, max_valid_depth)</span>
    
            
        <span class="file-info">[utils.py:350-352]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-55" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-55" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(55)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(55)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-55"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-55" oninput="previewComment(55)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">depth_values:</span> <span style="color: rgb(0, 86, 179);">numpy.ndarray()</span></div>
            
                <div><span style="color: #505050;">min_valid_depth:</span> <span style="color: rgb(0, 86, 179);">0.1</span></div>
            
                <div><span style="color: #505050;">max_valid_depth:</span> <span style="color: rgb(0, 86, 179);">10000.0</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">numpy.ndarray()</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(55)">Show/Hide</button>
                <div class="source-container" id="source-55">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">filter_invalid_depths</span><span class="token punctuation">(</span>
    depth_values<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span>
    min_valid_depth<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
    max_valid_depth<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">10000.0</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Filter out invalid depth values from the depth array.

    Args:
        depth_values: Array of depth values
        min_valid_depth: Minimum valid depth value
        max_valid_depth: Maximum valid depth value

    Returns:
        Filtered array of valid depth values
    """</span>
    <span class="token comment"># Remove NaN and infinite values</span>
    valid_mask <span class="token operator">=</span> np<span class="token punctuation">.</span>isfinite<span class="token punctuation">(</span>depth_values<span class="token punctuation">)</span>

    <span class="token comment"># Remove values outside reasonable depth range</span>
    valid_mask <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token punctuation">(</span>depth_values <span class="token operator">&gt;=</span> min_valid_depth<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>depth_values <span class="token operator">&lt;=</span> max_valid_depth<span class="token punctuation">)</span>

    <span class="token keyword">return</span> depth_values<span class="token punctuation">[</span>valid_mask<span class="token punctuation">]</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-0" id="node-58">
        <div class="call-header" onclick="toggleCall(58)">
            <span class="toggle-icon" id="icon-58">‚ñº</span>
            
        <span class="function-name">return estimate_height_in_cm_from_depth_map_height(box_height_in_depth_map_terms)</span>
    
            
        <span class="file-info">[utils.py:58-60]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-58" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-58" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(58)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(58)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-58"><p>This is a regression found by investigating "real" (printed) dimensions on boxes. It probably could be substituted with <code>0.1 * depth_map_height</code> without much impact.</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-58" oninput="previewComment(58)" placeholder="Type your comment here. Markdown is supported." data-comment="This is a regression found by investigating &quot;real&quot; (printed) dimensions on boxes. It probably could be substituted with `0.1 * depth_map_height` without much impact."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">depth_map_height:</span> <span style="color: rgb(0, 86, 179);">295.25</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">26.5922</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(58)">Show/Hide</button>
                <div class="source-container" id="source-58" style="display: block;" data-source-visible="true">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">estimate_height_in_cm_from_depth_map_height</span><span class="token punctuation">(</span>depth_map_height<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Estimate height in cm from depth_map_height map height.

    Args:
        depth_map_height: a "height" (approximately mm) from depth map values.

    Returns:
        Estimated height value.
    """</span>
    depth_map_height <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>depth_map_height<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
    <span class="token comment"># The "correct" equestion is 0.1 * depth_map_height</span>
    <span class="token comment"># (Luxonis promises Depth is in mm)</span>
    <span class="token comment"># But depth maps aren't perfect,</span>
    <span class="token comment"># our mask isn't perfect,</span>
    <span class="token comment"># and we may encounter flaps.</span>
    <span class="token comment"># So in addition to taking the 20th percentile depth of the box</span>
    <span class="token comment"># when calculating its height, we also use a slightly adjusted equation.</span>

    <span class="token comment"># Source: https://colab.research.google.com/drive/1ClJVYHmJMprJYyjY17GVSHZGw4_ZKbSj#scrollTo=f_uMbYVytsRB</span>
    <span class="token keyword">return</span> <span class="token number">0.0900</span> <span class="token operator">*</span> depth_map_height <span class="token operator">+</span> <span class="token number">0.0197</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-5" id="node-61">
        <div class="call-header" onclick="toggleCall(61)">
            <span class="toggle-icon" id="icon-61">‚ñº</span>
            
        <span class="function-name">dimensions = calculate_dimensions_from_polygon(polygon_coordinates, image_height, image_width, box_height_cm, device_id)</span>
    
            
        <span class="file-info">[utils.py:176-178]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-61" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-61" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(61)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(61)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-61"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-61" oninput="previewComment(61)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">polygon_coordinates:</span> <span style="color: rgb(0, 86, 179);">[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]</span></div>
            
                <div><span style="color: #505050;">image_height:</span> <span style="color: rgb(0, 86, 179);">1080</span></div>
            
                <div><span style="color: #505050;">image_width:</span> <span style="color: rgb(0, 86, 179);">1920</span></div>
            
                <div><span style="color: #505050;">box_height_cm:</span> <span style="color: rgb(0, 86, 179);">26.5922</span></div>
            
                <div><span style="color: #505050;">device_id:</span> <span style="color: rgb(0, 86, 179);">'SCN-011'</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">{'box_length_cm': 25.671628909271057, 'box_width_cm': 28.960996182914716, 'box_height_cm': 26.5922}</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(61)">Show/Hide</button>
                <div class="source-container" id="source-61">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calculate_dimensions_from_polygon</span><span class="token punctuation">(</span>
    polygon_coordinates<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    image_height<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    image_width<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    box_height_cm<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    device_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Calculate box dimensions from polygon coordinates and device parameters.

    Args:
        polygon_coordinates: List of polygon coordinate tuples.
        image_height: Height of the image in pixels.
        image_width: Width of the image in pixels.
        box_height_cm: Height of the box in centimeters.
        device_id: Device identifier for calibration parameters.

    Returns:
        Dictionary containing box dimensions in centimeters.
    """</span>
    min_rect<span class="token punctuation">,</span> rect_length_px<span class="token punctuation">,</span> rect_width_px<span class="token punctuation">,</span> angle <span class="token operator">=</span> calculate_min_area_rect<span class="token punctuation">(</span>
        polygon_coordinates<span class="token punctuation">,</span> image_height<span class="token punctuation">,</span> image_width
    <span class="token punctuation">)</span>

    box_dimensions_at_top <span class="token operator">=</span> estimate_box_dimensions_at_top_face<span class="token punctuation">(</span>
        rect_length_px<span class="token punctuation">,</span>
        rect_width_px<span class="token punctuation">,</span>
        box_height_cm<span class="token punctuation">,</span>
        device_id<span class="token operator">=</span>device_id<span class="token punctuation">,</span>
        device_params<span class="token operator">=</span>consts<span class="token punctuation">.</span>SITE_DIMENSION_DATA<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    length <span class="token operator">=</span> box_dimensions_at_top<span class="token punctuation">[</span><span class="token string">"box_length_cm"</span><span class="token punctuation">]</span>
    width <span class="token operator">=</span> box_dimensions_at_top<span class="token punctuation">[</span><span class="token string">"box_width_cm"</span><span class="token punctuation">]</span>
    height <span class="token operator">=</span> box_height_cm <span class="token keyword">or</span> <span class="token builtin">min</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> width<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"box_length_cm"</span><span class="token punctuation">:</span> length<span class="token punctuation">,</span>
        <span class="token string">"box_width_cm"</span><span class="token punctuation">:</span> width<span class="token punctuation">,</span>
        <span class="token string">"box_height_cm"</span><span class="token punctuation">:</span> height<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-0" id="node-62">
        <div class="call-header" onclick="toggleCall(62)">
            <span class="toggle-icon" id="icon-62">‚ñº</span>
            
        <span class="function-name">min_rect, rect_length_px, rect_width_px, angle = calculate_min_area_rect(polygon_coordinates, image_height, image_width)</span>
    
            
        <span class="file-info">[segmentation_ops.py:124-126]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-62" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-62" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(62)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(62)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-62"><p>This converts the polygon into a rectangle (with rotation) so we can get length and width of the box in pixels.</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-62" oninput="previewComment(62)" placeholder="Type your comment here. Markdown is supported." data-comment="This converts the polygon into a rectangle (with rotation) so we can get length and width of the box in pixels."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">normalized_polygon_coordinates:</span> <span style="color: rgb(0, 86, 179);">[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]</span></div>
            
                <div><span style="color: #505050;">image_height:</span> <span style="color: rgb(0, 86, 179);">1080</span></div>
            
                <div><span style="color: #505050;">image_width:</span> <span style="color: rgb(0, 86, 179);">1920</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">(((1093.64404296875, 572.4718017578125), (430.2251281738281, 400.96630859375), 28.024499893188477), 400.96630859375, 430.2251281738281, 118.02449989318848)</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(62)">Show/Hide</button>
                <div class="source-container" id="source-62">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calculate_min_area_rect</span><span class="token punctuation">(</span>
    normalized_polygon_coordinates<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    image_height<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    image_width<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span>Tuple<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Calculate the minimum area rectangle for a polygon.

    Args:
        normalized_polygon_coordinates: List of (x, y) normalized coordinates
        image_height: The height of the image
        image_width: The width of the image

    Returns:
        Tuple containing:
        - rect: The minimum area rectangle (center, (width, height), angle)
        - width: The width of the rectangle (shorter dimension)
        - length: The length of the rectangle (longer dimension)
        - angle: The orientation angle in degrees
    """</span>
    <span class="token comment"># Convert normalized coordinates to pixel coordinates</span>
    points <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>
        denormalize_polygon_coordinates<span class="token punctuation">(</span>
            normalized_polygon_coordinates<span class="token punctuation">,</span>
            image_height<span class="token punctuation">,</span>
            image_width<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># Find the minimum area rectangle using OpenCV</span>
    rect <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minAreaRect<span class="token punctuation">(</span>points<span class="token punctuation">)</span>

    <span class="token comment"># Get the width and height (rect[1] contains (width, height))</span>
    width<span class="token punctuation">,</span> height <span class="token operator">=</span> rect<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token comment"># Return with length as the longer dimension and width as the shorter one</span>
    <span class="token keyword">if</span> width <span class="token operator">&lt;=</span> height<span class="token punctuation">:</span>
        <span class="token keyword">return</span> rect<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> rect<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> rect<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> rect<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">90</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
            <div class="call-children">
                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-1" id="node-63">
        <div class="call-header" onclick="toggleCall(63)">
            <span class="toggle-icon" id="icon-63">‚ñ∂</span>
            
        <span class="function-name">points = np.array(denormalize_polygon_coordinates(normalized_polygon_coordinates,
            image_height,
            image_width))</span>
    
            
        <span class="file-info">[segmentation_ops.py:95-101]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content" id="content-63" data-expanded="false">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-63" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(63)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(63)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-63"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-63" oninput="previewComment(63)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">normalized_polygon_coordinates:</span> <span style="color: rgb(0, 86, 179);">[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]</span></div>
            
                <div><span style="color: #505050;">image_height:</span> <span style="color: rgb(0, 86, 179);">1080</span></div>
            
                <div><span style="color: #505050;">image_width:</span> <span style="color: rgb(0, 86, 179);">1920</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">[(1046, 320), (1313, 478), (1361, 512), (1361, 528), (1196, 838), (1179, 838), (822, 655), (822, 625), (996, 320)]</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(63)">Show/Hide</button>
                <div class="source-container" id="source-63">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">denormalize_polygon_coordinates</span><span class="token punctuation">(</span>
    normalized_polygon_coordinates<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    image_height<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    image_width<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Convert normalized polygon coordinates to pixel coordinates.

    Args:
        normalized_polygon_coordinates: List of (x, y) normalized coordinates
            (or NaN value)
        image_height: height in pixels
        image_width: width in pixels

    Returns:
        List of (x, y) pixel coordinates
    """</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>normalized_polygon_coordinates<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>x <span class="token operator">*</span> image_width<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">*</span> image_height<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> normalized_polygon_coordinates
    <span class="token punctuation">]</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-0" id="node-66">
        <div class="call-header" onclick="toggleCall(66)">
            <span class="toggle-icon" id="icon-66">‚ñº</span>
            
        <span class="function-name">box_dimensions_at_top = estimate_box_dimensions_at_top_face(rect_length_px,
        rect_width_px,
        box_height_cm,
        device_id=device_id,
        device_params=consts.SITE_DIMENSION_DATA)</span>
    
            
        <span class="file-info">[utils.py:128-134]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-66" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-66" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(66)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(66)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-66"><p>Once we have box width/length in pixels, convert to CM.</p>
<p>This requires us to know the width and length of the belt in CM, and how close the box is to the camera.</p>
<p>The closer the box is, the more pixels/cm there will be (just like a fly is large when close up).</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-66" oninput="previewComment(66)" placeholder="Type your comment here. Markdown is supported." data-comment="Once we have box width/length in pixels, convert to CM.

This requires us to know the width and length of the belt in CM, and how close the box is to the camera.

The closer the box is, the more pixels/cm there will be (just like a fly is large when close up)."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">box_top_length_px:</span> <span style="color: rgb(0, 86, 179);">400.96630859375</span></div>
            
                <div><span style="color: #505050;">box_top_width_px:</span> <span style="color: rgb(0, 86, 179);">430.2251281738281</span></div>
            
                <div><span style="color: #505050;">box_height_cm:</span> <span style="color: rgb(0, 86, 179);">26.5922</span></div>
            
                <div><span style="color: #505050;">device_id:</span> <span style="color: rgb(0, 86, 179);">'SCN-011'</span></div>
            
                <div><span style="color: #505050;">device_params:</span> <span style="color: rgb(0, 86, 179);">{'SCN-009': {'site': 'YVR2', 'device_id': 'SCN-009', 'camera_fov_y_degrees': 38.0, 'belt_width_px': 942.2, 'camera_height': 124.46, 'belt_width': 76.2, 'cm_per_pixel_y': 0.0793611384259847, 'cm_per_pixel_x': 0.08087454892804076}, 'SCN-010': {'site': 'YVR3', 'device_id': 'SCN-010', 'camera_fov_y_degrees': 38.0, 'belt_width_px': 1575, 'camera_height': 106.68, 'belt_width': 106.68, 'cm_per_pixel_y': 0.06802383293655832, 'cm_per_pixel_x': 0.06773333333333334}, 'SCN-011': {'site': 'YVR4', 'device_id': 'SCN-011', 'camera_fov_y_degrees': 38.0, 'belt_width_px': 1312.6, 'camera_height': 127.0, 'belt_width': 111.76, 'cm_per_pixel_y': 0.08098075349590277, 'cm_per_pixel_x': 0.0851439890294073}, 'SCN-012': {'site': 'YXX2', 'device_id': 'SCN-012', 'camera_fov_y_degrees': 38.0, 'belt_width_px': 1455.8, 'camera_height': 111.76, 'belt_width': 101.6, 'cm_per_pixel_y': 0.07126306307639443, 'cm_per_pixel_x': 0.06978980629207308}, 'SCN-109': {'site': 'YVR2', 'device_id': 'SCN-009', 'camera_fov_y_degrees': 38.0, 'belt_width_px': 942.2, 'camera_height': 124.46, 'belt_width': 76.2, 'cm_per_pixel_y': 0.0793611384259847, 'cm_per_pixel_x': 0.08087454892804076}, 'SCN-410': {'site': 'YVR3', 'device_id': 'SCN-010', 'camera_fov_y_degrees': 38.0, 'belt_width_px': 1575, 'camera_height': 106.68, 'belt_width': 106.68, 'cm_per_pixel_y': 0.06802383293655832, 'cm_per_pixel_x': 0.06773333333333334}, 'SCN-312': {'site': 'YXX2', 'device_id': 'SCN-012', 'camera_fov_y_degrees': 38.0, 'belt_width_px': 1455.8, 'camera_height': 111.76, 'belt_width': 101.6, 'cm_per_pixel_y': 0.07126306307639443, 'cm_per_pixel_x': 0.06978980629207308}}</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">{'box_length_cm': 25.671628909271057, 'box_width_cm': 28.960996182914716}</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(66)">Show/Hide</button>
                <div class="source-container" id="source-66" style="display: block;" data-source-visible="true">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">estimate_box_dimensions_at_top_face</span><span class="token punctuation">(</span>
    box_top_length_px<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
    box_top_width_px<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
    box_height_cm<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    device_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    device_params<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Dict<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Estimate box top face CM dimensions from pixel dimensions.

    Since a taller box is closer to the camera, take height into account.
    As the distance between the box face and the camera goes to zero,
    the pixels/cm increases proportionally.

    Args:
        box_top_length_px (float): Box length in pixels (belt direction).
        box_top_width_px (float): Box width in pixels (across belt).
        box_height_cm (float): Height of the box above the belt in cm.
        device_id (str): ID of the camera device.
        device_params (Dict[str, Dict]): Dictionary of device calibration data.

    Returns:
        Dict[str, float]: {'box_length_cm', 'box_width_cm'} corrected for
            top-face proximity.
    """</span>
    device <span class="token operator">=</span> device_params<span class="token punctuation">[</span>device_id<span class="token punctuation">]</span>
    camera_height_cm <span class="token operator">=</span> device<span class="token punctuation">[</span><span class="token string">"camera_height"</span><span class="token punctuation">]</span>
    <span class="token comment"># if the depth map is not available, we have to guess</span>
    box_height_cm <span class="token operator">=</span> box_height_cm <span class="token keyword">or</span> <span class="token number">20</span>
    box_face_depth <span class="token operator">=</span> camera_height_cm <span class="token operator">-</span> box_height_cm

    scale_factor <span class="token operator">=</span> box_face_depth <span class="token operator">/</span> camera_height_cm
    cm_per_pixel_y_top <span class="token operator">=</span> device<span class="token punctuation">[</span><span class="token string">"cm_per_pixel_y"</span><span class="token punctuation">]</span> <span class="token operator">*</span> scale_factor
    cm_per_pixel_x_top <span class="token operator">=</span> device<span class="token punctuation">[</span><span class="token string">"cm_per_pixel_x"</span><span class="token punctuation">]</span> <span class="token operator">*</span> scale_factor

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"box_length_cm"</span><span class="token punctuation">:</span> box_top_length_px <span class="token operator">*</span> cm_per_pixel_y_top<span class="token punctuation">,</span>
        <span class="token string">"box_width_cm"</span><span class="token punctuation">:</span> box_top_width_px <span class="token operator">*</span> cm_per_pixel_x_top<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-3" id="node-71">
        <div class="call-header" onclick="toggleCall(71)">
            <span class="toggle-icon" id="icon-71">‚ñº</span>
            
        <span class="function-name">result_df = utils.compute_surface_area_and_bbox_area(cardboard_box_df,
        surface_area_features)</span>
    
            
        <span class="file-info">[utils.py:131-134]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-71" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-71" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(71)">Edit Comment</button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(71)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-71"><p>This is the final equation to get the surface area from the surface area features:</p>
<pre><code>Surface Area = 2 * (L * W + L * H + W * H)
</code></pre>
<p>Where L, W, and H are the estimated cardboard box dimensions in cm.</p>
<p>It's encoded in the column <code>surface_area</code>.</p>
</div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-71" oninput="previewComment(71)" placeholder="Type your comment here. Markdown is supported." data-comment="This is the final equation to get the surface area from the surface area features:

```
Surface Area = 2 * (L * W + L * H + W * H)
```

Where L, W, and H are the estimated cardboard box dimensions in cm.

It's encoded in the column `surface_area`."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">df:</span> <span style="color: rgb(0, 86, 179);">DataFrame (1√ó11) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_45.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_45" data-expanded="false" onclick="toggleImageSize('img_45')">
                             </div></span></div>
            
                <div><span style="color: #505050;">weight_features:</span> <span style="color: rgb(0, 86, 179);">{'box_length_cm': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': 25.671628909271057}, 'box_width_cm': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': 28.960996182914716}, 'box_height_cm': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': 26.5922}, 'device_id': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': 'SCN-011'}, 'polygon_coordinates': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': [(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]}, 'has_depth_map': {'1962afe0-3adc-4ef1-abd2-7db962b58f8d': True}}</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">DataFrame (1√ó19) - Showing all rows:<br><pre style="background:#f1f1f1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; overflow-x: auto;">image_name,xmin,ymin,xmax,ymax,score,class_name,image_width,image_height,area,id,box_length_cm,box_width_cm,box_height_cm,device_id,polygon_coordinates,has_depth_map,surface_area,bbox_area
s3://scanner-data.us-west-2/SCN-011/2025/07/01/15/36/32-102661_0.jpg,0.43,0.16,0.75,0.79,0.96,CARDBOARD,1920,1080,0.2,1962afe0-3adc-4ef1-abd2-7db962b58f8d,25.67,28.96,26.59,SCN-011,"[(0.5447916666666667, 0.2962962962962963), (0.6838541666666667, 0.4425925925925926), (0.7088541666666667, 0.4740740740740741), (0.7088541666666667, 0.4888888888888889), (0.6229166666666667, 0.7759259259259259), (0.6140625, 0.7759259259259259), (0.428125, 0.6064814814814815), (0.428125, 0.5787037037037037), (0.51875, 0.2962962962962963)]",True,4392.56,0.2
</pre><br><strong>Annotated Image:</strong><br><div style="display: flex; flex-direction: column;">
                                 <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #495057;">numpy.ndarray((1080, 1920, 3), uint8)</div>
                                 <img src="images/img_46.png" alt="NumPy array visualization" title="numpy.ndarray((1080, 1920, 3), uint8)" class="trace-image" id="trace-img-img_46" data-expanded="false" onclick="toggleImageSize('img_46')">
                             </div></div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(71)">Show/Hide</button>
                <div class="source-container" id="source-71" data-source-visible="false">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">compute_surface_area_and_bbox_area</span><span class="token punctuation">(</span>
    df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
    weight_features<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Compute surface area and bounding box area from features.

    Args:
        df: Input DataFrame containing detection data.
        weight_features: Dictionary of weight features to add to DataFrame.

    Returns:
        DataFrame with added surface area and bounding box area columns.
    """</span>
    result_df <span class="token operator">=</span> df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> feature<span class="token punctuation">,</span> value_map <span class="token keyword">in</span> weight_features<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result_df<span class="token punctuation">[</span>feature<span class="token punctuation">]</span> <span class="token operator">=</span> result_df<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>value_map<span class="token punctuation">)</span>

    L <span class="token operator">=</span> result_df<span class="token punctuation">[</span><span class="token string">"box_length_cm"</span><span class="token punctuation">]</span>
    W <span class="token operator">=</span> result_df<span class="token punctuation">[</span><span class="token string">"box_width_cm"</span><span class="token punctuation">]</span>
    H <span class="token operator">=</span> result_df<span class="token punctuation">[</span><span class="token string">"box_height_cm"</span><span class="token punctuation">]</span>
    ymin <span class="token operator">=</span> result_df<span class="token punctuation">[</span><span class="token string">"ymin"</span><span class="token punctuation">]</span>
    xmin <span class="token operator">=</span> result_df<span class="token punctuation">[</span><span class="token string">"xmin"</span><span class="token punctuation">]</span>
    ymax <span class="token operator">=</span> result_df<span class="token punctuation">[</span><span class="token string">"ymax"</span><span class="token punctuation">]</span>
    xmax <span class="token operator">=</span> result_df<span class="token punctuation">[</span><span class="token string">"xmax"</span><span class="token punctuation">]</span>

    result_df<span class="token punctuation">[</span><span class="token string">"surface_area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>L <span class="token operator">*</span> W <span class="token operator">+</span> L <span class="token operator">*</span> H <span class="token operator">+</span> W <span class="token operator">*</span> H<span class="token punctuation">)</span>
    result_df<span class="token punctuation">[</span><span class="token string">"bbox_area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ymax <span class="token operator">-</span> ymin<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>xmax <span class="token operator">-</span> xmin<span class="token punctuation">)</span>

    <span class="token keyword">return</span> result_df
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
                    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="call-node depth-2" id="node-74">
        <div class="call-header" onclick="toggleCall(74)">
            <span class="toggle-icon" id="icon-74">‚ñº</span>
            
        <span class="function-name">result_df["weight"] = result_df.apply(lambda row: utils.estimate_weight_from_surface_area(row.device_id, row.surface_area),
            axis="columns")</span>
    
            
        <span class="file-info">[utils.py:46-51]</span>
    
            
        <span class="thread-info">Thread: 129404183094976</span>
    
        </div>
        <div class="call-content show" id="content-74" data-expanded="true">
            <div class="call-info">
                
        <div class="comment-section" id="comment-section-74" data-editing="false">
            <div class="comment-header">
                <div class="section-title">Comment</div>
                <button class="comment-toggle-edit-btn" onclick="enterCommentEditMode(74)">
                    Add Comment
                </button>
                <button class="comment-save-btn" onclick="saveAndExitCommentEditMode(74)">Save</button>
            </div>
            <div class="comment-content">
                <div class="comment-output" id="comment-output-74"></div>
                <div class="comment-edit-controls">
                    <textarea class="comment-input" id="comment-input-74" oninput="previewComment(74)" placeholder="Type your comment here. Markdown is supported."></textarea>
                </div>
            </div>
        </div>
    
                <div class="args-section">
                    <div class="section-title">Arguments:</div>
                    <div class="args-list">
        
            
                <div><span style="color: #505050;">scanner_id:</span> <span style="color: rgb(0, 86, 179);">'SCN-011'</span></div>
            
                <div><span style="color: #505050;">surface_area:</span> <span style="color: rgb(0, 86, 179);">4392.555279654049</span></div>
            
        
    </div>
                </div>
                
        
            <div class="return-section">
                <div class="section-title">Return Value:</div>
                <div class="return-value">325.3363279464092</div>
            </div>
        
    
                
        
            <div class="source-section">
                <div class="section-title">Source Code</div>
                <button class="source-toggle" onclick="toggleSource(74)">Show/Hide</button>
                <div class="source-container" id="source-74" style="display: block;" data-source-visible="true">
                    <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">estimate_weight_from_surface_area</span><span class="token punctuation">(</span>scanner_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> surface_area<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Estimate weight from surface area using device-specific coefficients.

    Args:
        scanner_id: Scanner device identifier.
        surface_area: Calculated surface area value.

    Returns:
        Estimated weight value, or NaN if scanner_id is invalid.
    """</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> scanner_id<span class="token punctuation">:</span>
        <span class="token keyword">return</span> pd<span class="token punctuation">.</span>NA
    coefficients <span class="token operator">=</span> consts<span class="token punctuation">.</span>SURFACE_AREA_COEFFICIENTS<span class="token punctuation">[</span>scanner_id<span class="token punctuation">]</span>
    slope <span class="token operator">=</span> coefficients<span class="token punctuation">[</span><span class="token string">"slope"</span><span class="token punctuation">]</span>
    intercept <span class="token operator">=</span> coefficients<span class="token punctuation">[</span><span class="token string">"intercept"</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> slope <span class="token operator">*</span> surface_area <span class="token operator">+</span> intercept
</code></pre>
                </div>
            </div>
        
    
            </div>
            
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

                
            </div>
        
    
        </div>
    </div>

            
        
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
    (function() {
        if (!window.sessionStorage || !window.marked) {
            console.warn("Tracer features like state persistence or Markdown comments may not work.");
            return;
        }

        const requestId = document.body.dataset.requestId;
        const stateKey = `traceState_${requestId}`;

        function getTraceState() {
            try {
                const storedState = sessionStorage.getItem(stateKey);
                return storedState ? JSON.parse(storedState) : {};
            } catch (e) {
                console.error("Could not read trace state from sessionStorage", e);
                return {};
            }
        }

        function saveTraceState(state) {
            try {
                sessionStorage.setItem(stateKey, JSON.stringify(state));
            } catch (e) {
                console.error("Could not save trace state to sessionStorage", e);
            }
        }

        function updateNodeState(id, key, value) {
            const state = getTraceState();
            if (!state[id]) state[id] = {};
            state[id][key] = value;
            saveTraceState(state);
        }

        function updateImageState(id, key, value) {
            const state = getTraceState();
            const imageKey = `image_${id}`;
            if (!state[imageKey]) state[imageKey] = {};
            state[imageKey][key] = value;
            saveTraceState(state);
        }

        window.toggleCall = function(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (!content || !icon) return;

            const isVisible = content.classList.toggle('show');
            icon.textContent = isVisible ? '‚ñº' : '‚ñ∂';
            content.dataset.expanded = isVisible ? 'true' : 'false';
            updateNodeState(id, 'expanded', isVisible);
        };

        window.toggleImageSize = function(id) {
            const img = document.getElementById(`trace-img-${id}`);
            if (!img) return;

            const isExpanded = img.dataset.expanded === 'true' ? 'false' : 'true';
            img.dataset.expanded = isExpanded;
            
            updateImageState(id, 'expanded', isExpanded);
        };

        window.toggleSource = function(id) {
            const container = document.getElementById(`source-${id}`);
            if (!container) return;

            const isVisible = container.style.display !== 'block';
            container.style.display = isVisible ? 'block' : 'none';
            container.dataset.sourceVisible = isVisible;
            updateNodeState(id, 'sourceVisible', isVisible);
        };
        
        window.previewComment = function(id) {
            const input = document.getElementById(`comment-input-${id}`);
            const output = document.getElementById(`comment-output-${id}`);
            if (!input || !output) return;
            output.innerHTML = marked.parse(input.value);
            if (window.Prism) {
                Prism.highlightAllUnder(output);
            }
        };

        window.enterCommentEditMode = function(id) {
            const section = document.getElementById(`comment-section-${id}`);
            if (!section) return;
            section.dataset.editing = 'true';
            section.querySelector('.comment-input').focus();
        };
        
        window.saveAndExitCommentEditMode = function(id) {
            const section = document.getElementById(`comment-section-${id}`);
            const input = document.getElementById(`comment-input-${id}`);
            const button = section.querySelector('.comment-toggle-edit-btn');
            if (!section || !input || !button) return;
            
            section.dataset.editing = 'false';
            const markdownText = input.value;
            input.dataset.comment = markdownText;
            updateNodeState(id, 'comment', markdownText);
            button.textContent = markdownText ? 'Edit Comment' : 'Add Comment';
        };

        window.exportFullHTML = function() {
            const filename = `trace_${requestId}_${new Date().toISOString().slice(0,19).replace('T','_').replace(/:/g,'-')}.html`;
            const clonedDoc = document.documentElement.cloneNode(true);
            const state = getTraceState();

            Object.keys(state).forEach(id => {
                if (id.startsWith('image_')) {
                    const imageId = id.replace('image_', '');
                    const imageState = state[id];
                    const img = clonedDoc.querySelector(`#trace-img-${imageId}`);
                    
                    if (img && imageState.expanded !== undefined) {
                        img.dataset.expanded = imageState.expanded;
                    }
                } else {
                    const nodeState = state[id];
                    const contentEl = clonedDoc.querySelector(`#content-${id}`);
                    const sourceEl = clonedDoc.querySelector(`#source-${id}`);
                    const noteEl = clonedDoc.querySelector(`#comment-input-${id}`);

                    if (contentEl && nodeState.expanded !== undefined) contentEl.dataset.expanded = nodeState.expanded;
                    if (sourceEl && nodeState.sourceVisible !== undefined) sourceEl.dataset.sourceVisible = nodeState.sourceVisible;
                    if (noteEl && nodeState.comment !== undefined) noteEl.dataset.comment = nodeState.comment;
                }
            });

            const htmlContent = '<!DOCTYPE html>\n' + clonedDoc.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        function loadInitialState() {
            const state = getTraceState();
            Object.keys(state).forEach(id => {
                if (id.startsWith('image_')) {
                    const imageId = id.replace('image_', '');
                    const imageState = state[id];
                    const img = document.getElementById(`trace-img-${imageId}`);
                    
                    if (img && imageState.expanded !== undefined) {
                        img.dataset.expanded = imageState.expanded;
                    }
                } else {
                    const nodeState = state[id];
                    
                    if (nodeState.expanded) {
                        window.toggleCall(id);
                    }

                    if (nodeState.sourceVisible) {
                        const container = document.getElementById(`source-${id}`);
                        if (container) container.style.display = 'block';
                    }

                    if (nodeState.comment !== undefined) {
                        const section = document.getElementById(`comment-section-${id}`);
                        if (!section) return;
                        
                        const input = section.querySelector(`#comment-input-${id}`);
                        const output = section.querySelector(`#comment-output-${id}`);
                        const button = section.querySelector('.comment-toggle-edit-btn');
                        
                        if(input && output && button) {
                            input.value = nodeState.comment;
                            input.dataset.comment = nodeState.comment;
                            output.innerHTML = marked.parse(nodeState.comment);
                            if(window.Prism) { Prism.highlightAllUnder(output); }
                            button.textContent = nodeState.comment ? 'Edit Comment' : 'Add Comment';
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialState();
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    })();
    </script>

</body></html>